// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Generated from TAQ Database

//@version=5
indicator("Daily Max Spread % (TAQ Data)", shorttitle="MaxSpread%", overlay=false, precision=4)

// ============================================================================
// HOW DAILY MAX SPREAD VALUES ARE CALCULATED
// ============================================================================
// Data Source: TAQ (Trade and Quote) 1-minute bar data
//
// For each trading day, the MAX spread percentage is calculated as:
//
//   1. For each 1-minute bar, we have:
//      - MaxSpread: The maximum bid-ask spread during that minute
//
//   2. Daily Max Spread = MAX(MaxSpread) across all ~390 minutes
//      This is the WIDEST spread that occurred at any point during the day
//
//   3. Mid Price = AVG of (CloseBidPrice + CloseAskPrice) / 2 for the day
//
//   4. Final Daily Max Spread % = (Daily Max Spread / Mid Price) * 100
//
// Example: If a stock has:
//   - Max spread of $0.25 (widest point in the day)
//   - Average mid price of $100
//   - Daily Max Spread % = (0.25 / 100) * 100 = 0.25%
//
// Lower values = tighter max spreads = more consistently liquid
// Higher values = wider max spreads = liquidity gaps during the day
// ============================================================================

// ============================================================================
// AVAILABLE DATA COLUMNS IN TAQ DATABASE (for future indicators)
// ============================================================================
// 
// SPREAD DATA OPTIONS:
// --------------------
// Current:  MAX(MaxSpread) - Widest spread that occurred during the day
// 
// Other spread columns available in taq_1min table:
//   • MinSpread          - Tightest spread during each minute
//                          Use: AVG(MinSpread) for avg tightest, MIN(MinSpread) for best liquidity
//   • MaxSpread          - Widest spread during each minute (CURRENTLY USING MAX OF THIS)
//   • CloseBidPrice      - Bid price at end of each minute
//   • CloseAskPrice      - Ask price at end of each minute
//                          Use: CloseAskPrice - CloseBidPrice for close spread
//   • NBBO_BidPrice      - National Best Bid (across all exchanges)
//   • NBBO_AskPrice      - National Best Offer (across all exchanges)
//                          Use: NBBO_AskPrice - NBBO_BidPrice for NBBO spread
//   • TimeWeightedSpread - Spread weighted by time at each level
//                          Use: AVG(TimeWeightedSpread) for time-weighted avg
//
// POSSIBLE SPREAD CALCULATIONS TO ADD:
// -------------------------------------
// 1. AVG Spread:     AVG(MaxSpread) or AVG(MinSpread)
// 2. Min Spread:     MIN(MinSpread) - Tightest spread all day
// 3. Close Spread:   Last minute's (CloseAskPrice - CloseBidPrice)
// 4. NBBO Spread:    AVG(NBBO_AskPrice - NBBO_BidPrice)
// 5. TWAS:           AVG(TimeWeightedSpread) - Time-weighted average spread
// 6. Spread Range:   MAX(MaxSpread) - MIN(MinSpread) - Daily spread volatility
//
// VOLUME/LIQUIDITY DATA:
// ----------------------
//   • Volume            - Total shares traded per minute
//   • VWAP              - Volume-weighted average price
//   • DollarVolume      - Volume × Price (notional value)
//   • TradeCount        - Number of trades per minute
//   • AvgTradeSize      - Average shares per trade
//
// PRICE DATA:
// -----------
//   • Open, High, Low, Close - Standard OHLC
//   • TWAP                   - Time-weighted average price
//
// OTHER TABLES AVAILABLE:
// -----------------------
//   • daily_summary   - Pre-aggregated daily stats
//   • ticker_info     - Ticker metadata
//   • available_dates - List of trading days
//
// DATA COVERAGE:
// --------------
//   • 51 Tickers: ABBV, ABT, ALB, AMD, BABA, BIDU, CL, CMCSA, CRM, CRWD,
//                 DELL, DG, DHR, EOG, F, FCX, FSLR, GD, GDDY, GEV, GLW,
//                 GOOGL, GS, HAL, HPE, HSY, INTC, IP, JD, JNJ, KEY, KHC,
//                 LEN, LIN, LLY, MAR, MARA, MDT, MMM, MOS, MRVL, MSFT,
//                 NEM, ORCL, PATH, PCG, PFE, PG, PLTR, PPLT, RCL
//   • Date Range: Last 60 trading days
//   • Resolution: 1-minute bars (~390 per day)
//
// TO REGENERATE THIS INDICATOR WITH DIFFERENT DATA:
// -------------------------------------------------
// 1. Modify the SQL query in the Python generator script
// 2. Change MAX(MaxSpread) to desired aggregation
// 3. Run the script to regenerate this Pine Script file
// 
// Example SQL for AVG spread instead of MAX:
//   SELECT Date, Ticker, AVG(MaxSpread) as spread, AVG((CloseBidPrice + CloseAskPrice)/2) as mid
//   FROM taq_1min GROUP BY Date, Ticker
//
// Example SQL for MIN spread (best liquidity):
//   SELECT Date, Ticker, MIN(MinSpread) as spread, AVG((CloseBidPrice + CloseAskPrice)/2) as mid
//   FROM taq_1min GROUP BY Date, Ticker
//
// Example SQL for time-weighted spread:
//   SELECT Date, Ticker, AVG(TimeWeightedSpread) as spread, AVG((CloseBidPrice + CloseAskPrice)/2) as mid
//   FROM taq_1min GROUP BY Date, Ticker
//
// ============================================================================

// ============================================================================
// CONFIGURATION
// ============================================================================
showHistogram = input.bool(true, "Show as Histogram", group="Display")
showLine = input.bool(true, "Show Line", group="Display")
spreadColor = input.color(color.new(color.red, 0), "Spread Color", group="Display")
avgColor = input.color(color.new(color.orange, 0), "Average Color", group="Display")
avgLength = input.int(10, "Average Length", minval=1, maxval=50, group="Display")

// ============================================================================
// DATE ARRAY (60 trading days)
// ============================================================================
var int[] dates = array.from(20250828, 20250829, 20250902, 20250903, 20250904, 20250905, 20250908, 20250909, 20250910, 20250911, 20250912, 20250915, 20250916, 20250917, 20250918, 20250919, 20250922, 20250923, 20250924, 20250925, 20250926, 20250929, 20250930, 20251001, 20251002, 20251003, 20251006, 20251007, 20251008, 20251009, 20251010, 20251013, 20251014, 20251015, 20251016, 20251017, 20251020, 20251021, 20251022, 20251023, 20251024, 20251027, 20251028, 20251029, 20251030, 20251031, 20251103, 20251104, 20251105, 20251106, 20251107, 20251110, 20251111, 20251112, 20251113, 20251114, 20251117, 20251118, 20251119, 20251120)

// ============================================================================
// MAX SPREAD DATA BY TICKER (stored as basis points * 100 for precision)
// Split into multiple functions to avoid Pine Script limits
// ============================================================================

getSpreadData_0(string ticker) =>
    switch ticker
        "ABBV" => array.from(255.2, 344.07, 239.89, 458.66, 198.54, 243.67, 253.92, 325.46, 428.95, 448.06, 731.01, 511.44, 299.42, 184.54, 159.07, 388.98, 419.74, 671.47, 677.61, 582.12, 331.87, 399.68, 662.36, 377.11, 290.94, 2939.54, 473.43, 704.35, 2815.04, 2740.75, 934.13, 2343.05, 365.88, 178.34, 433.6, 441.15, 173.38, 228.04, 243.57, 341.7, 350.33, 2918.28, 2923.63, 2939.52, 2727.19, 1515.65, 343.07, 313.87, 418.18, 229.69, 352.29, 223.55, 519.86, 483.92, 563.82, 733.52, 441.53, 368.47, 490.97, 388.78)
        "ABT" => array.from(278.41, 3886.64, 223.97, 233.23, 359.84, 184.67, 372.53, 312.55, 296.12, 251.65, 488.27, 218.71, 301.92, 625.96, 491.19, 302.65, 348.87, 313.08, 255.4, 573.45, 663.43, 295.45, 435.26, 512.96, 232.0, 507.45, 469.53, 335.69, 423.86, 362.11, 941.52, 148.36, 2470.34, 554.8, 359.89, 194.49, 173.55, 273.61, 163.92, 273.63, 227.29, 4038.13, 4031.36, 4082.22, 900.44, 195.58, 242.27, 216.32, 168.85, 336.58, 235.14, 238.69, 223.2, 234.85, 426.29, 147.68, 159.81, 231.43, 295.42, 303.66)
        "ALB" => array.from(389.45, 278.59, 222.2, 315.1, 341.38, 240.88, 347.23, 320.01, 136.3, 7861.95, 399.97, 204.82, 283.93, 371.69, 312.87, 351.36, 297.49, 448.28, 260.89, 319.12, 178.4, 215.93, 341.81, 350.73, 147.9, 385.63, 206.01, 332.15, 251.11, 317.22, 267.41, 352.09, 335.14, 265.32, 235.83, 366.28, 207.39, 306.33, 391.33, 285.29, 246.91, 20050.19, 4886.94, 2324.79, 2735.92, 2777.48, 244.53, 159.78, 492.94, 268.35, 516.59, 396.38, 213.95, 288.69, 319.78, 617.73, 225.17, 418.74, 192.08, 309.82)
        "AMD" => array.from(66.82, 73.08, 54.8, 54.25, 129.66, 62.07, 74.07, 62.1, 44.91, 91.89, 55.86, 64.96, 54.71, 50.33, 130.92, 71.39, 70.41, 69.54, 74.38, 70.11, 70.3, 58.85, 69.6, 93.7, 127.68, 95.47, 208.2, 94.53, 58.57, 56.23, 75.34, 59.25, 130.9, 52.15, 70.88, 77.71, 60.09, 65.34, 77.45, 66.81, 67.78, 2872.66, 1975.84, 3222.91, 8582.53, 4961.39, 78.92, 261.46, 80.01, 74.22, 77.36, 98.49, 103.79, 77.58, 67.02, 97.47, 68.98, 72.95, 98.9, 90.25)
        "BABA" => array.from(75.06, 235.3, 81.43, 81.86, 68.96, 190.0, 143.89, 1446.15, 113.22, 78.27, 77.71, 60.6, 59.89, 57.82, 202.68, 78.0, 123.62, 4554.71, 1663.46, 61.65, 57.63, 55.34, 80.5, 69.63, 183.48, 144.75, 67.27, 161.38, 69.53, 163.72, 212.31, 131.53, 1858.48, 121.27, 101.32, 6619.21, 160.32, 42.73, 57.84, 84.94, 159.99, 2152.82, 4121.62, 166.37, 4228.13, 3891.66, 77.97, 58.62, 117.69, 99.81, 175.85, 50.46, 81.75, 120.83, 91.46, 88.03, 75.7, 93.43, 59.98, 124.54)
        "BIDU" => array.from(212.99, 165.8, 194.76, 165.86, 153.13, 164.2, 274.2, 206.8, 193.1, 189.78, 147.55, 172.32, 174.04, 685.3, 208.57, 243.02, 157.07, 206.31, 178.76, 232.69, 264.84, 223.57, 97.23, 213.82, 301.54, 350.0, 128.93, 2010.96, 1180.14, 1113.48, 567.96, 3170.0, 141.2, 99.64, 1626.88, 125.5, 3983.86, 2488.57, 3300.56, 153.06, 3961.58, 3793.15, 14840.39, 3763.51, 3582.9, 3429.41, 13078.53, 12517.71, 15160.14, 12095.96, 12091.53, 11594.13, 11651.26, 242.19, 216.13, 531.72, 1361.34, 4339.2, 184.74, 15967.91)
        "CL" => array.from(446.96, 213.68, 194.96, 181.41, 218.96, 283.13, 271.77, 182.75, 325.76, 212.66, 158.67, 241.85, 227.08, 255.69, 225.72, 238.16, 236.76, 461.49, 248.57, 254.29, 258.67, 358.73, 243.3, 358.5, 421.94, 250.09, 159.4, 287.46, 217.81, 179.19, 279.28, 151.33, 166.02, 2178.49, 2178.46, 284.86, 141.69, 227.46, 231.44, 193.76, 183.67, 1337.28, 1193.51, 1074.08, 1232.44, 280.23, 216.19, 163.51, 161.77, 218.96, 138.11, 213.93, 187.39, 455.61, 197.96, 201.2, 249.43, 212.62, 313.45, 203.98)
        "CMCSA" => array.from(619.18, 817.83, 265.12, 337.08, 276.97, 442.48, 231.14, 591.0, 499.85, 320.57, 223.38, 310.51, 404.07, 504.91, 431.85, 164.55, 171.55, 239.77, 221.2, 189.49, 352.79, 195.8, 209.24, 334.27, 306.54, 292.45, 239.77, 355.75, 273.48, 197.12, 314.83, 246.85, 309.11, 218.01, 233.88, 169.96, 135.26, 110.81, 208.57, 200.48, 190.8, 3344.08, 2728.37, 172.77, 1871.36, 6582.98, 722.58, 172.87, 517.17, 325.75, 255.92, 216.4, 164.62, 260.46, 153.47, 436.6, 189.59, 146.47, 221.47, 410.45)
        "CRM" => array.from(118.38, 117.19, 177.55, 198.86, 113.05, 96.69, 108.66, 114.84, 5031.71, 105.9, 127.58, 111.66, 5187.01, 114.49, 102.98, 88.82, 94.8, 149.61, 149.11, 123.69, 82.46, 112.86, 109.51, 140.71, 131.45, 164.83, 123.9, 143.87, 109.92, 148.09, 212.26, 136.59, 158.82, 119.67, 159.79, 184.38, 110.12, 111.47, 176.78, 145.3, 122.08, 618.2, 618.88, 1980.7, 1961.46, 2987.48, 190.65, 119.03, 148.89, 170.46, 165.44, 175.54, 133.33, 161.16, 205.41, 206.88, 159.89, 143.15, 153.77, 264.41)
        "CRWD" => array.from(291.93, 2409.91, 1399.67, 2158.81, 2161.16, 2146.87, 1574.19, 8531.81, 2087.9, 1056.59, 2038.71, 2402.35, 1023.17, 1020.35, 1823.14, 1098.49, 2571.97, 5218.97, 1537.43, 1998.28, 2197.78, 2067.84, 1290.51, 1928.58, 701.05, 1314.37, 93.91, 3722.51, 1466.13, 885.46, 6223.37, 8439.96, 5608.78, 3009.74, 3046.67, 1011.25, 884.42, 2185.0, 6990.96, 6823.15, 1442.53, 6596.17, 6463.97, 1422.01, 2717.66, 6461.07, 2300.97, 727.45, 263.21, 1024.84, 1013.22, 8700.26, 1015.79, 489.62, 6530.88, 1008.88, 905.29, 1038.81, 895.68, 844.8)
        => array.new<float>(0)

getSpreadData_1(string ticker) =>
    switch ticker
        "DELL" => array.from(606.45, 215.9, 149.66, 293.83, 188.16, 214.83, 258.78, 177.94, 208.06, 196.96, 225.46, 167.58, 141.05, 154.5, 254.28, 230.43, 118.15, 118.99, 120.65, 193.35, 177.79, 642.31, 240.54, 178.57, 127.47, 304.47, 197.81, 550.25, 237.09, 131.47, 147.82, 130.02, 7617.31, 811.01, 865.92, 1308.53, 906.59, 206.62, 201.04, 264.07, 181.42, 442.27, 624.93, 1039.96, 7033.06, 3802.09, 477.61, 196.32, 250.68, 264.2, 262.35, 161.42, 193.14, 256.54, 374.41, 250.08, 272.76, 204.99, 224.54, 313.7)
        "DG" => array.from(643.59, 860.5, 712.92, 868.09, 802.26, 606.21, 608.49, 503.3, 488.5, 495.25, 496.02, 401.6, 542.12, 536.59, 409.58, 955.03, 481.2, 859.56, 1260.22, 662.58, 843.19, 650.27, 819.76, 2086.55, 871.92, 820.42, 828.41, 881.72, 766.24, 850.36, 799.68, 748.34, 383.52, 799.29, 780.19, 726.06, 886.85, 877.63, 895.4, 838.4, 851.43, 2145.61, 918.81, 908.44, 901.58, 5257.44, 824.75, 826.98, 1120.25, 1109.75, 961.42, 865.98, 1165.1, 770.11, 978.2, 1271.71, 967.83, 829.79, 1119.39, 701.65)
        "DHR" => array.from(468.19, 1292.05, 442.63, 545.73, 582.61, 599.51, 447.88, 596.2, 282.31, 318.82, 320.82, 369.67, 389.23, 437.25, 565.09, 663.69, 270.05, 4367.09, 2439.08, 1953.21, 415.48, 284.66, 470.22, 678.47, 1058.4, 489.46, 468.51, 508.43, 458.96, 867.82, 833.48, 516.85, 1147.84, 638.19, 918.92, 702.91, 594.88, 507.19, 1510.29, 916.76, 483.14, 3299.14, 1927.35, 8916.04, 2739.23, 3401.62, 706.41, 941.87, 693.47, 825.39, 585.77, 987.19, 934.23, 481.85, 966.71, 626.08, 1983.2, 1498.17, 1603.32, 1414.01)
        "EOG" => array.from(1040.2, 1029.73, 1756.32, 882.88, 896.27, 1235.5, 469.77, 576.47, 802.64, 724.96, 542.02, 461.86, 538.52, 538.57, 722.62, 625.98, 725.32, 712.27, 998.31, 773.96, 650.31, 707.36, 1263.16, 1139.62, 854.94, 388.9, 1382.39, 652.92, 1467.44, 1182.2, 956.79, 1041.41, 1043.22, 2211.61, 881.97, 545.06, 694.9, 2010.96, 508.22, 320.97, 921.14, 2058.28, 917.28, 893.76, 902.84, 907.51, 508.58, 682.95, 468.38, 954.23, 800.3, 480.74, 588.2, 641.67, 492.93, 761.07, 364.05, 364.62, 1737.12, 661.87)
        "F" => array.from(203.46, 238.3, 162.26, 266.0, 197.34, 170.7, 136.73, 216.08, 236.25, 172.06, 179.27, 119.71, 240.84, 171.43, 178.99, 154.22, 128.95, 187.37, 196.6, 293.5, 337.11, 331.85, 233.21, 223.03, 334.7, 201.81, 220.67, 173.16, 193.97, 241.11, 226.85, 199.7, 155.46, 170.62, 230.09, 219.59, 192.01, 193.51, 160.54, 240.56, 119.41, 4563.83, 205.03, 68.07, 3074.23, 1819.81, 3294.77, 179.09, 138.16, 2591.96, 144.92, 151.85, 150.68, 179.18, 268.95, 143.73, 237.8, 208.55, 246.5, 268.48)
        "FCX" => array.from(280.1, 241.05, 225.2, 336.66, 157.2, 317.58, 388.56, 240.4, 192.63, 351.88, 157.73, 151.01, 308.34, 188.16, 439.68, 164.41, 186.61, 149.61, 306.37, 252.53, 162.8, 177.52, 214.19, 168.97, 115.2, 163.62, 155.77, 191.23, 103.42, 10578.65, 3228.95, 116.93, 1992.8, 186.79, 172.26, 194.14, 166.76, 183.8, 119.85, 180.97, 169.07, 1693.63, 2579.16, 10654.01, 2162.18, 2533.76, 620.4, 196.64, 174.91, 293.22, 176.7, 436.08, 292.49, 131.9, 223.72, 204.23, 206.99, 400.61, 203.66, 184.79)
        "FSLR" => array.from(315.87, 279.59, 383.27, 276.42, 269.84, 512.22, 308.97, 488.59, 327.58, 340.96, 285.48, 394.82, 246.43, 263.52, 421.48, 249.45, 250.81, 271.53, 244.21, 444.24, 491.93, 431.42, 366.65, 592.88, 371.51, 466.24, 272.07, 809.85, 720.76, 283.51, 342.53, 235.55, 505.77, 510.81, 350.66, 373.08, 413.3, 420.28, 514.76, 476.84, 342.76, 6407.46, 3324.34, 5242.34, 5397.07, 3028.62, 345.22, 390.65, 347.92, 524.51, 426.43, 407.6, 301.65, 615.66, 1047.39, 312.61, 5686.71, 453.5, 353.27, 598.8)
        "GD" => array.from(1287.14, 1287.96, 944.13, 1859.59, 1224.67, 1031.54, 417.16, 650.72, 815.04, 675.04, 1296.31, 1298.97, 1385.28, 465.48, 989.67, 1648.6, 1023.99, 644.01, 682.87, 644.86, 686.83, 671.89, 628.65, 1032.21, 2743.66, 10173.43, 2297.92, 9089.24, 10016.98, 2221.84, 9577.54, 1609.44, 2662.99, 1694.06, 10091.5, 10275.31, 10152.09, 2211.94, 961.34, 423.29, 817.48, 565.28, 1003.41, 429.83, 1130.53, 1346.58, 982.19, 606.52, 1755.2, 939.46, 1006.33, 688.11, 770.97, 947.07, 1208.38, 643.31, 1041.96, 613.31, 617.51, 734.22)
        "GDDY" => array.from(542.63, 1257.18, 4012.54, 3897.41, 2591.08, 6023.01, 3762.08, 7370.64, 8566.47, 4782.06, 5993.27, 3054.99, 3465.94, 6331.98, 5979.77, 3105.94, 8592.15, 6071.08, 7175.88, 5256.01, 7278.96, 2446.77, 4089.01, 1258.34, 2580.43, 1427.2, 1535.21, 1570.95, 1542.02, 4179.99, 2605.22, 1406.93, 1115.72, 1921.0, 802.39, 1818.2, 1561.54, 1013.76, 2484.13, 1968.05, 1972.99, 925.51, 2648.64, 1755.57, 2133.32, 4076.92, 5416.7, 5984.73, 2312.04, 4962.04, 7725.26, 5958.11, 4384.05, 4977.55, 2748.07, 4785.53, 9690.55, 7084.01, 7179.25, 6706.95)
        "GEV" => array.from(441.83, 338.57, 469.21, 5380.98, 320.48, 4876.97, 127.43, 394.98, 611.84, 345.07, 347.23, 9252.45, 112.56, 2404.29, 9763.66, 2709.02, 450.86, 611.44, 9169.15, 1207.2, 463.05, 214.9, 2533.34, 1802.3, 2493.31, 1166.28, 1264.74, 1141.7, 856.4, 9229.32, 286.91, 211.5, 183.88, 1062.3, 2034.1, 2257.38, 1498.46, 1345.56, 3716.27, 678.46, 1118.18, 1480.63, 1389.33, 295.78, 930.33, 858.78, 341.58, 200.91, 1060.84, 649.42, 404.7, 2006.52, 1906.47, 3877.26, 2728.74, 618.11, 2499.74, 1671.09, 1286.88, 2620.22)
        => array.new<float>(0)

getSpreadData_2(string ticker) =>
    switch ticker
        "GLW" => array.from(704.54, 292.73, 222.09, 423.24, 280.73, 254.68, 239.3, 165.65, 323.83, 256.9, 251.03, 210.82, 178.95, 275.37, 243.51, 276.43, 238.0, 240.2, 283.3, 212.3, 262.69, 189.89, 282.59, 604.52, 264.44, 335.48, 253.91, 234.66, 287.62, 239.05, 363.84, 184.4, 325.57, 252.55, 709.2, 305.83, 315.26, 286.65, 210.74, 234.4, 333.0, 6103.47, 358.98, 2766.49, 2754.9, 6077.67, 276.77, 196.68, 226.22, 231.56, 297.36, 177.27, 206.84, 593.74, 3249.48, 269.69, 596.2, 341.95, 579.44, 542.33)
        "GOOGL" => array.from(48.54, 42.51, 2527.88, 986.25, 52.64, 59.55, 61.26, 50.65, 48.8, 45.05, 54.9, 43.52, 46.39, 46.75, 42.85, 51.26, 51.37, 46.36, 34.48, 101.33, 58.33, 60.75, 54.44, 44.49, 64.91, 58.74, 53.27, 89.32, 84.09, 42.91, 66.92, 44.22, 49.22, 53.1, 56.67, 62.09, 50.85, 73.53, 79.06, 80.79, 50.6, 38.95, 50.25, 151.86, 86.64, 46.82, 50.17, 87.03, 54.67, 52.56, 54.97, 29.89, 83.17, 55.41, 59.72, 162.42, 73.11, 53.93, 61.98, 60.91)
        "GS" => array.from(519.76, 467.22, 264.98, 279.19, 319.95, 224.45, 191.31, 393.23, 891.86, 131.51, 319.65, 223.42, 279.99, 138.14, 209.21, 308.42, 397.27, 212.8, 423.94, 193.32, 199.75, 199.05, 439.76, 283.43, 209.6, 292.53, 235.46, 257.72, 437.14, 160.49, 322.34, 765.25, 437.75, 217.72, 342.04, 183.62, 195.09, 134.78, 171.77, 177.81, 3610.95, 4181.78, 476.43, 158.47, 265.76, 2866.87, 143.41, 247.7, 373.81, 486.26, 254.34, 156.96, 139.53, 148.52, 204.03, 200.9, 280.04, 547.75, 284.26, 237.68)
        "HAL" => array.from(312.76, 352.81, 269.16, 222.97, 263.02, 260.71, 255.74, 310.68, 374.12, 195.9, 223.97, 222.08, 261.93, 218.96, 214.42, 281.86, 263.72, 285.86, 286.06, 248.57, 419.01, 235.54, 582.62, 283.26, 381.46, 335.05, 298.68, 1089.12, 187.13, 203.36, 405.91, 290.42, 291.39, 244.66, 217.7, 232.32, 854.27, 483.77, 303.68, 166.31, 593.91, 223.17, 910.9, 874.11, 278.49, 2789.32, 353.29, 241.01, 210.14, 211.53, 254.98, 126.34, 282.87, 313.23, 257.66, 244.76, 572.29, 266.42, 328.22, 271.24)
        "HPE" => array.from(578.44, 361.04, 347.8, 503.68, 344.29, 231.99, 434.63, 298.76, 350.01, 251.12, 879.86, 464.35, 857.07, 671.74, 270.32, 214.94, 191.61, 167.64, 295.96, 388.44, 245.51, 384.04, 354.67, 633.47, 262.69, 354.36, 209.23, 344.29, 222.23, 226.02, 197.62, 550.62, 395.42, 715.82, 172.1, 211.77, 209.62, 255.71, 260.34, 185.33, 303.46, 346.45, 905.87, 886.73, 893.24, 436.5, 236.45, 365.46, 207.19, 335.38, 738.7, 288.09, 245.07, 295.8, 350.33, 214.17, 361.52, 256.76, 292.14, 526.03)
        "HSY" => array.from(3437.06, 2146.57, 1877.49, 1438.61, 3238.07, 2829.22, 5679.83, 2809.04, 4297.35, 3057.21, 2656.02, 837.91, 370.91, 583.83, 2823.74, 2735.45, 1310.92, 1314.84, 627.66, 742.09, 1415.47, 1431.38, 1500.0, 6576.05, 929.56, 1995.8, 880.31, 1104.04, 796.79, 706.35, 946.12, 1451.12, 1465.92, 1450.29, 1439.12, 1385.16, 920.06, 2129.79, 5399.83, 6888.13, 3025.91, 528.18, 2725.77, 6501.43, 2153.32, 7209.4, 1039.04, 1190.78, 614.95, 2905.61, 2337.79, 839.06, 1402.31, 1263.89, 1337.0, 1276.0, 952.61, 5510.24, 908.81, 6818.32)
        "INTC" => array.from(56.26, 53.02, 62.46, 66.63, 61.87, 61.41, 49.07, 44.89, 57.12, 56.73, 53.44, 48.69, 63.79, 51.94, 266.38, 56.92, 41.25, 47.64, 48.98, 444.14, 90.3, 75.06, 65.53, 69.59, 46.46, 69.79, 89.14, 59.35, 53.77, 74.69, 64.01, 143.11, 55.79, 60.1, 108.08, 76.31, 47.45, 36.79, 59.32, 228.68, 71.21, 35.67, 3665.73, 84.24, 2015.51, 3720.62, 93.06, 71.77, 515.1, 1723.67, 76.87, 44.09, 73.62, 79.05, 40.94, 73.45, 65.4, 58.35, 103.08, 66.06)
        "IP" => array.from(302.43, 641.97, 468.9, 639.96, 533.98, 625.65, 582.74, 580.98, 558.34, 636.45, 1182.62, 331.56, 349.52, 576.32, 647.58, 644.07, 484.93, 494.45, 462.27, 270.8, 458.24, 419.31, 686.64, 869.26, 757.91, 741.21, 540.6, 233.3, 449.03, 680.41, 501.36, 439.36, 771.43, 695.84, 490.15, 572.47, 557.04, 596.77, 414.15, 329.63, 546.91, 828.61, 918.03, 2176.06, 999.57, 1573.89, 191.6, 426.62, 357.12, 645.55, 727.22, 3069.79, 792.6, 785.28, 1324.13, 234.34, 397.31, 418.41, 738.65, 856.59)
        "JD" => array.from(305.16, 304.2, 302.76, 295.49, 259.08, 293.98, 309.8, 323.18, 286.82, 376.49, 271.5, 265.7, 239.96, 255.58, 222.37, 253.24, 174.76, 251.68, 224.34, 232.57, 219.9, 3672.23, 210.12, 782.56, 209.24, 190.28, 224.05, 226.22, 195.54, 232.97, 245.65, 296.22, 186.44, 198.64, 242.53, 434.41, 227.41, 236.17, 239.59, 253.67, 2829.17, 251.71, 195.79, 181.95, 104.23, 75.71, 213.43, 282.38, 256.91, 223.48, 221.46, 222.53, 240.13, 247.17, 269.21, 296.43, 269.97, 288.83, 343.78, 319.42)
        "JNJ" => array.from(156.15, 174.8, 157.85, 237.38, 148.36, 237.32, 161.73, 164.12, 119.98, 197.42, 136.45, 112.57, 223.25, 104.62, 138.32, 156.81, 148.88, 170.45, 141.67, 132.79, 163.65, 133.9, 102.96, 303.42, 101.84, 201.74, 136.62, 240.53, 142.71, 104.98, 141.38, 115.76, 274.79, 175.16, 140.94, 154.11, 184.04, 93.43, 119.46, 129.92, 120.35, 1153.22, 513.44, 149.87, 1906.1, 250.21, 160.01, 214.18, 106.1, 106.17, 202.29, 229.36, 103.51, 154.53, 128.2, 204.16, 114.6, 124.77, 157.01, 154.24)
        => array.new<float>(0)

getSpreadData_3(string ticker) =>
    switch ticker
        "KEY" => array.from(485.31, 3624.62, 342.87, 720.14, 781.51, 441.07, 384.03, 386.54, 334.26, 339.15, 3907.58, 736.54, 640.09, 831.05, 384.15, 603.21, 439.52, 509.19, 478.45, 879.32, 472.46, 704.51, 391.97, 227.02, 432.6, 381.51, 503.68, 577.79, 430.88, 875.06, 332.26, 422.52, 1947.02, 557.89, 515.82, 302.08, 649.47, 985.67, 650.38, 387.9, 383.08, 276.2, 585.27, 879.0, 2232.09, 314.1, 553.52, 385.71, 384.4, 1084.59, 383.51, 379.87, 385.63, 834.07, 962.9, 1017.37, 806.24, 617.28, 689.07, 344.05)
        "KHC" => array.from(934.06, 108.64, 317.46, 60.24, 104.09, 110.63, 133.55, 141.84, 146.86, 157.48, 106.53, 115.67, 116.26, 115.71, 80.78, 110.21, 106.06, 120.83, 157.58, 152.37, 73.12, 162.52, 127.52, 183.74, 134.14, 107.27, 167.49, 138.26, 126.99, 131.81, 366.42, 231.19, 99.02, 118.83, 166.79, 146.14, 74.04, 140.29, 144.01, 160.97, 126.31, 2717.16, 2707.12, 5697.9, 999.26, 2437.72, 102.52, 115.42, 82.72, 116.77, 99.86, 82.33, 118.26, 105.51, 132.29, 184.76, 113.3, 181.76, 144.57, 128.28)
        "LEN" => array.from(3318.87, 1753.4, 2031.1, 856.37, 1762.99, 26660.86, 2811.48, 1727.31, 1386.15, 4101.35, 1681.48, 1840.19, 2167.45, 1255.63, 5708.86, 388.11, 3083.65, 5152.6, 7036.84, 3578.04, 480.35, 2573.91, 3479.15, 3571.3, 1988.68, 2468.7, 2490.11, 3893.72, 2218.07, 870.52, 1528.2, 496.82, 501.12, 1516.76, 2440.45, 14360.12, 918.5, 195.47, 7899.54, 3607.42, 3384.03, 2144.81, 3833.53, 2090.29, 9245.41, 1250.24, 1521.19, 1146.51, 6164.89, 15647.24, 1119.26, 5100.39, 2201.42, 905.68, 5692.22, 700.31, 1766.34, 2780.45, 6728.2, 5165.04)
        "LIN" => array.from(1047.46, 963.7, 1324.47, 859.89, 862.28, 982.25, 687.81, 1287.0, 636.36, 789.35, 945.46, 1055.76, 963.27, 738.77, 742.14, 612.13, 741.99, 655.51, 367.19, 656.85, 1431.38, 689.87, 1708.87, 599.98, 548.38, 642.5, 462.59, 533.3, 575.57, 1110.76, 919.19, 458.34, 774.31, 1406.01, 808.79, 790.73, 1213.43, 387.07, 753.37, 709.51, 1267.78, 273.82, 679.9, 617.84, 788.0, 515.41, 454.7, 731.71, 1457.2, 308.76, 221.54, 1210.33, 277.24, 327.45, 224.11, 328.61, 245.69, 1110.74, 155.67, 194.12)
        "LLY" => array.from(111.0, 103.36, 112.57, 115.77, 137.99, 105.95, 176.22, 107.38, 91.16, 87.83, 112.71, 88.7, 68.33, 130.47, 94.56, 70.23, 95.9, 78.8, 114.58, 170.82, 129.89, 77.31, 121.36, 142.81, 131.86, 128.05, 149.05, 114.35, 79.26, 89.18, 99.18, 116.6, 110.83, 279.95, 306.04, 222.08, 121.2, 171.08, 169.71, 232.9, 133.95, 199.59, 2715.43, 2559.79, 1627.52, 2873.43, 127.54, 150.49, 177.17, 123.27, 143.21, 1811.85, 2170.62, 99.24, 3481.43, 89.79, 224.47, 104.31, 170.81, 124.21)
        "MAR" => array.from(1212.74, 3633.23, 1122.36, 1567.76, 5435.53, 7725.67, 1111.97, 789.71, 1116.98, 709.09, 1108.46, 1112.01, 576.49, 623.6, 659.99, 655.35, 1885.5, 1904.21, 1992.64, 778.51, 921.34, 749.59, 1014.31, 1660.82, 801.97, 1038.63, 1725.59, 1815.29, 3812.01, 879.8, 1931.2, 6710.1, 1209.99, 2307.84, 2491.74, 6374.22, 1543.32, 2092.41, 1646.13, 1725.91, 1136.74, 2184.15, 2655.09, 1900.43, 4419.0, 1669.72, 1599.46, 891.62, 1090.53, 1066.8, 1363.18, 822.91, 924.62, 731.64, 2169.27, 2390.08, 562.51, 4952.82, 3377.58, 946.31)
        "MARA" => array.from(168.63, 728.59, 206.55, 181.28, 181.43, 131.82, 216.86, 108.75, 149.55, 113.01, 130.61, 105.71, 77.0, 327.66, 147.71, 135.84, 251.9, 71.37, 72.22, 173.3, 130.28, 392.73, 488.04, 80.48, 57.98, 100.28, 130.75, 64.49, 191.32, 139.45, 854.82, 312.01, 199.17, 218.62, 282.91, 558.44, 105.11, 226.85, 286.62, 329.59, 163.27, 1874.68, 2572.77, 2581.33, 735.72, 424.44, 116.14, 440.05, 255.74, 156.94, 397.52, 318.22, 292.67, 371.74, 279.94, 317.16, 238.63, 154.04, 200.22, 201.43)
        "MDT" => array.from(216.25, 292.79, 276.81, 497.12, 244.92, 412.04, 429.83, 267.97, 428.96, 296.66, 411.96, 235.46, 426.75, 377.19, 528.05, 697.85, 451.41, 969.42, 1422.4, 1009.98, 339.42, 223.28, 317.92, 532.58, 257.76, 415.36, 205.48, 357.44, 306.32, 1134.28, 542.4, 622.62, 508.29, 598.65, 609.65, 601.24, 324.25, 313.24, 624.85, 529.77, 606.48, 1119.13, 1383.48, 1286.28, 5420.46, 1617.5, 191.88, 184.41, 199.97, 188.81, 230.35, 248.36, 244.27, 585.55, 258.2, 359.22, 500.7, 683.7, 670.05, 280.75)
        "MMM" => array.from(498.41, 497.6, 270.14, 461.37, 315.77, 390.42, 315.93, 381.5, 276.82, 494.47, 637.01, 286.4, 348.53, 314.22, 321.34, 288.07, 236.27, 450.08, 362.42, 317.81, 235.45, 260.74, 504.66, 402.29, 415.89, 256.95, 298.67, 395.22, 333.29, 313.64, 463.5, 345.39, 329.5, 409.98, 249.24, 329.47, 311.91, 531.04, 245.76, 217.13, 197.82, 563.53, 917.71, 936.91, 894.27, 640.38, 257.99, 251.81, 308.17, 335.55, 531.35, 569.65, 363.38, 315.07, 2221.3, 310.65, 277.53, 423.68, 461.19, 330.86)
        "MOS" => array.from(4023.57, 3695.42, 4062.98, 4104.8, 5873.62, 3804.47, 3819.33, 3829.32, 3784.74, 3694.26, 3682.84, 3645.72, 3650.64, 3647.5, 3624.82, 3635.83, 3682.24, 3671.05, 3533.76, 2000.98, 3537.69, 3545.39, 3579.32, 3056.62, 1697.92, 3022.42, 2992.06, 2079.83, 2117.18, 1982.04, 1746.02, 1487.34, 659.48, 443.16, 861.78, 1021.52, 892.77, 1927.11, 1013.3, 1016.99, 1010.6, 501.12, 903.21, 904.55, 1113.03, 4443.49, 1015.21, 4740.67, 4856.27, 1037.25, 1005.4, 1007.48, 1026.12, 1019.55, 6159.01, 6094.61, 1045.29, 1015.96, 1026.8, 6351.3)
        => array.new<float>(0)

getSpreadData_4(string ticker) =>
    switch ticker
        "MRVL" => array.from(365.03, 359.0, 213.73, 213.68, 194.16, 2388.45, 291.79, 261.43, 160.65, 358.07, 258.7, 227.67, 321.08, 115.41, 166.88, 145.68, 257.94, 244.86, 122.21, 113.5, 430.03, 153.81, 128.14, 508.87, 149.41, 4634.34, 2416.36, 2833.48, 3882.06, 2390.55, 207.18, 124.75, 160.44, 407.24, 143.93, 476.91, 92.37, 251.0, 206.65, 346.62, 205.49, 5169.81, 5948.72, 942.82, 417.72, 7983.08, 678.39, 119.09, 180.77, 7665.9, 165.91, 203.13, 253.5, 318.95, 188.12, 203.63, 254.35, 297.06, 222.93, 282.19)
        "MSFT" => array.from(44.23, 152.64, 53.49, 64.47, 44.44, 64.93, 45.09, 50.02, 45.14, 57.68, 53.98, 68.44, 45.59, 49.08, 61.12, 63.41, 45.44, 71.11, 49.05, 51.18, 68.65, 55.64, 70.7, 60.45, 65.39, 50.26, 59.54, 64.36, 44.6, 54.78, 50.31, 65.61, 71.11, 50.57, 53.83, 76.21, 55.42, 40.26, 59.97, 40.25, 69.55, 667.73, 456.83, 316.45, 341.35, 1740.41, 48.24, 48.91, 45.87, 64.87, 55.41, 55.2, 49.97, 63.88, 60.3, 59.68, 60.18, 51.27, 85.61, 49.5)
        "NEM" => array.from(523.19, 545.31, 4585.05, 6063.38, 74.93, 172.17, 83.97, 115.71, 180.11, 115.58, 112.04, 152.03, 113.61, 145.23, 214.47, 94.36, 100.77, 176.92, 75.05, 212.39, 94.71, 98.04, 143.18, 186.66, 160.53, 96.95, 106.17, 91.31, 187.72, 107.52, 135.8, 167.8, 124.62, 129.0, 184.74, 154.81, 154.86, 153.62, 200.54, 286.65, 133.67, 505.5, 2953.1, 673.93, 311.68, 4941.3, 160.04, 140.97, 192.74, 162.75, 190.15, 327.49, 184.89, 112.87, 140.3, 242.97, 239.86, 228.48, 985.05, 1833.71)
        "ORCL" => array.from(133.32, 140.52, 129.02, 111.89, 166.75, 124.49, 138.39, 352.03, 3227.1, 95.38, 105.78, 63.47, 67.71, 79.35, 109.98, 88.98, 209.97, 147.39, 88.16, 86.1, 104.67, 77.57, 124.99, 157.6, 3728.49, 2199.98, 1842.29, 2377.42, 6250.52, 91.72, 111.28, 84.89, 144.63, 103.59, 204.39, 113.71, 63.56, 86.03, 71.7, 75.51, 73.88, 4573.09, 3829.37, 2093.73, 1597.89, 2021.8, 139.93, 84.12, 77.15, 95.28, 80.41, 79.2, 84.74, 91.73, 104.69, 109.96, 80.33, 172.43, 88.02, 81.44)
        "PATH" => array.from(7551.5, 8280.78, 7788.1, 6500.93, 1765.18, 289.75, 5714.81, 430.79, 5758.85, 5832.15, 425.49, 5885.06, 362.91, 5775.94, 5619.11, 5642.77, 4799.48, 4522.39, 1365.62, 1701.41, 993.36, 5431.9, 1189.5, 2237.18, 1677.9, 903.07, 200.31, 498.91, 304.54, 649.35, 504.55, 278.05, 784.73, 4431.1, 4532.67, 5647.79, 1977.17, 3702.24, 1074.72, 2488.92, 167.12, 2879.5, 873.4, 2737.87, 1217.35, 359.78, 1013.06, 1103.75, 1011.93, 6109.2, 1025.55, 1016.3, 217.41, 994.93, 197.4, 265.86, 290.42, 575.76, 613.49, 979.31)
        "PCG" => array.from(512.34, 918.19, 817.17, 570.14, 622.81, 825.15, 812.31, 743.68, 727.8, 796.2, 557.96, 402.16, 652.81, 787.61, 437.68, 942.21, 761.19, 2053.08, 3428.51, 6103.77, 3476.26, 1390.03, 2797.68, 611.32, 693.98, 562.86, 593.52, 543.5, 535.45, 557.14, 547.91, 525.42, 498.75, 531.53, 684.48, 649.83, 511.38, 488.39, 699.47, 1110.98, 857.01, 2851.43, 2880.42, 4409.16, 5047.12, 2696.03, 736.12, 695.09, 932.44, 330.38, 636.06, 532.29, 421.76, 557.33, 562.42, 845.05, 540.91, 466.22, 927.27, 1010.49)
        "PFE" => array.from(52.41, 44.5, 76.55, 56.34, 133.97, 81.0, 93.29, 60.82, 89.4, 64.72, 61.55, 75.19, 70.9, 78.91, 57.96, 54.0, 53.46, 49.63, 53.9, 50.32, 71.61, 58.77, 44.65, 56.47, 110.93, 47.62, 63.11, 128.95, 73.01, 101.93, 83.93, 108.92, 89.39, 98.11, 57.44, 102.63, 44.64, 60.58, 80.68, 72.89, 88.92, 129.33, 125.9, 130.87, 1405.43, 138.89, 194.77, 57.16, 171.57, 165.36, 57.4, 81.93, 60.19, 50.74, 54.09, 67.18, 51.61, 63.4, 71.66, 73.13)
        "PG" => array.from(131.23, 97.05, 101.48, 121.77, 89.32, 107.16, 158.32, 110.62, 147.12, 141.67, 102.38, 96.64, 111.73, 100.3, 147.58, 87.96, 153.86, 98.34, 204.41, 104.95, 131.41, 88.32, 119.64, 177.73, 126.05, 94.44, 132.12, 116.0, 100.27, 85.0, 159.68, 108.63, 108.53, 143.53, 155.17, 1829.86, 65.9, 98.86, 108.94, 2369.27, 228.97, 1987.95, 1983.49, 1906.49, 657.02, 2409.07, 128.87, 132.79, 124.11, 124.73, 134.9, 115.38, 118.93, 132.31, 127.5, 106.63, 143.26, 95.55, 114.44, 122.09)
        "PLTR" => array.from(66.28, 61.36, 51.42, 99.37, 56.69, 62.26, 51.41, 39.99, 64.95, 41.61, 58.94, 47.71, 47.57, 43.05, 41.3, 39.95, 67.33, 44.04, 49.79, 65.49, 81.06, 60.34, 33.37, 62.83, 62.78, 59.98, 80.42, 84.25, 49.1, 49.14, 44.3, 60.74, 70.91, 44.86, 70.07, 66.12, 38.08, 54.66, 35.71, 65.57, 68.6, 7602.61, 7599.25, 10261.36, 11632.87, 6221.31, 361.24, 89.3, 64.13, 59.53, 87.37, 52.19, 57.61, 80.65, 71.4, 52.29, 43.07, 69.56, 66.68, 61.22)
        "PPLT" => array.from(1109.47, 1535.91, 1531.4, 3158.64, 2422.5, 1199.92, 204.61, 1507.6, 1881.1, 1888.89, 1885.39, 835.12, 1713.62, 1745.57, 2237.71, 1090.58, 916.7, 1517.02, 6103.18, 716.44, 1258.79, 462.47, 5188.81, 1258.82, 1077.38, 2524.0, 4471.09, 4438.77, 210.66, 2829.01, 3240.51, 1834.36, 355.31, 740.63, 918.5, 4136.18, 898.65, 3754.36, 2384.76, 1535.39, 2489.67, 1239.17, 1225.45, 3559.05, 1550.87, 4904.42, 2092.6, 842.73, 947.32, 1422.41, 1950.79, 1461.15, 648.59, 1530.79, 791.99, 2661.23, 928.16, 1754.56, 913.85, 829.55)
        => array.new<float>(0)

getSpreadData_5(string ticker) =>
    switch ticker
        "RCL" => array.from(446.41, 2091.54, 324.72, 5068.18, 594.8, 607.04, 600.13, 601.84, 482.25, 3105.7, 589.38, 176.14, 895.33, 506.86, 252.75, 619.59, 942.75, 583.03, 859.79, 2409.83, 445.39, 683.76, 1912.35, 1657.42, 7110.69, 1004.24, 316.81, 318.32, 6837.44, 226.6, 3314.07, 1170.22, 628.51, 414.29, 248.39, 516.58, 2143.8, 1578.03, 275.54, 2374.06, 635.4, 3129.9, 841.86, 1986.67, 281.79, 1617.41, 940.9, 3000.68, 5813.67, 940.25, 1011.91, 2525.56, 3686.91, 941.94, 425.91, 457.79, 1021.91, 396.01, 894.91, 3603.62)
        => array.new<float>(0)

// Main function to get spread data for any ticker
getSpreadData(string ticker) =>
    if array.includes(array.from("ABBV", "ABT", "ALB", "AMD", "BABA", "BIDU", "CL", "CMCSA", "CRM", "CRWD"), ticker)
        getSpreadData_0(ticker)
    else if array.includes(array.from("DELL", "DG", "DHR", "EOG", "F", "FCX", "FSLR", "GD", "GDDY", "GEV"), ticker)
        getSpreadData_1(ticker)
    else if array.includes(array.from("GLW", "GOOGL", "GS", "HAL", "HPE", "HSY", "INTC", "IP", "JD", "JNJ"), ticker)
        getSpreadData_2(ticker)
    else if array.includes(array.from("KEY", "KHC", "LEN", "LIN", "LLY", "MAR", "MARA", "MDT", "MMM", "MOS"), ticker)
        getSpreadData_3(ticker)
    else if array.includes(array.from("MRVL", "MSFT", "NEM", "ORCL", "PATH", "PCG", "PFE", "PG", "PLTR", "PPLT"), ticker)
        getSpreadData_4(ticker)
    else if array.includes(array.from("RCL"), ticker)
        getSpreadData_5(ticker)
    else
        array.new<float>(0)

// ============================================================================
// MAIN LOGIC
// ============================================================================
currentTicker = str.replace_all(syminfo.ticker, "NASDAQ:", "")
currentTicker := str.replace_all(currentTicker, "NYSE:", "")
currentTicker := str.replace_all(currentTicker, "AMEX:", "")

spreadData = getSpreadData(currentTicker)
currentDate = year * 10000 + month * 100 + dayofmonth

var float spreadValue = na
if array.size(spreadData) > 0
    for i = 0 to array.size(dates) - 1
        if array.get(dates, i) == currentDate
            spreadValue := array.get(spreadData, i) / 100
            break

var float[] spreadHistory = array.new<float>(0)
if not na(spreadValue) and barstate.isconfirmed
    array.push(spreadHistory, spreadValue)
    if array.size(spreadHistory) > 100
        array.shift(spreadHistory)

avgSpread = array.size(spreadHistory) >= avgLength ? array.avg(array.slice(spreadHistory, array.size(spreadHistory) - avgLength, array.size(spreadHistory))) : na

// ============================================================================
// PLOTTING
// ============================================================================
plot(showHistogram ? spreadValue : na, "Max Spread %", spreadColor, style=plot.style_histogram, linewidth=4)
plot(showLine ? spreadValue : na, "Max Spread Line", spreadColor, linewidth=2)
plot(avgSpread, "Avg of Max Spread", avgColor, linewidth=2)
hline(0, "Zero", color.gray, linestyle=hline.style_dotted)

// ============================================================================
// INFO TABLE
// ============================================================================
var table infoTable = table.new(position.top_right, 2, 4, bgcolor=color.new(color.black, 80), frame_color=color.gray, frame_width=1, border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "Symbol", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, currentTicker, text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 1, "Date", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(currentDate), text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 2, "Max Spread %", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, na(spreadValue) ? "N/A" : str.tostring(spreadValue, "#.####") + "%", text_color=na(spreadValue) ? color.gray : color.lime, text_size=size.small)
    table.cell(infoTable, 0, 3, "Avg Max Spread", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, na(avgSpread) ? "N/A" : str.tostring(avgSpread, "#.####") + "%", text_color=na(avgSpread) ? color.gray : color.orange, text_size=size.small)

alertcondition(spreadValue > 1.0, "High Max Spread Alert", "Max Spread is above 1.0%")
