<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Raw Data Viewer - Market Microstructure</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      height: 100%; 
      background: #0e1117; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace; 
      color: #fff;
    }
    
    .nav { 
      position: fixed; top: 0; left: 0; right: 0; 
      background: rgba(14, 17, 23, 0.95); 
      padding: 12px 20px; 
      z-index: 1000; 
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid #2a2a2a;
    }
    
    .nav-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
    .nav-button { 
      color: #fff; 
      background: #2a2a2a; 
      border: none; 
      padding: 8px 14px; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 13px;
      transition: all 0.2s;
    }
    .nav-button:hover { background: #3a3a3a; }
    .nav-button.active { background: #00d4aa; color: #000; }
    
    .controls { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-left: auto;
    }
    
    .ticker-select, .date-display {
      background: #1a1a2e;
      border: 1px solid #333;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .ticker-select { min-width: 120px; cursor: pointer; }
    .ticker-select:focus { outline: none; border-color: #00d4aa; }
    
    .container {
      margin-top: 70px;
      padding: 20px;
      max-width: 100%;
      overflow: auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #1a1a2e;
      border-radius: 8px;
      border: 1px solid #333;
    }
    
    .header h1 {
      font-size: 24px;
      color: #00d4aa;
    }
    
    .header-info {
      font-size: 14px;
      color: #888;
    }
    
    .pagination {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .pagination button {
      background: #2a2a2a;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .pagination button:hover:not(:disabled) { background: #00d4aa; color: #000; }
    .pagination button:disabled { opacity: 0.3; cursor: not-allowed; }
    
    .pagination select {
      background: #1a1a2e;
      color: #fff;
      border: 1px solid #333;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .table-wrapper {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #333;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1a1a2e;
      font-size: 12px;
    }
    
    thead {
      position: sticky;
      top: 0;
      background: #0e1117;
      z-index: 10;
    }
    
    th {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 2px solid #00d4aa;
      font-weight: 600;
      color: #00d4aa;
      white-space: nowrap;
    }
    
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #2a2a2a;
      color: #ccc;
    }
    
    tr:hover {
      background: rgba(0, 212, 170, 0.1);
    }
    
    .number {
      text-align: right;
      font-family: 'Courier New', monospace;
    }
    
    .positive { color: #00FF88; }
    .negative { color: #FF4444; }
    .neutral { color: #FFD700; }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
      font-size: 16px;
    }
    
    .date-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-arrow {
      background: #2a2a2a;
      border: none;
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .date-arrow:hover { background: #00d4aa; color: #000; }
    .date-arrow:disabled { opacity: 0.3; cursor: not-allowed; }
    
    .date-display {
      min-width: 100px;
      text-align: center;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-tabs">
      <button onclick="navigateTo('/')" class="nav-button">Chart</button>
      <button onclick="navigateTo('/spread')" class="nav-button">Spread</button>
      <button onclick="navigateTo('/vwap')" class="nav-button">VWAP</button>
      <button onclick="navigateTo('/volume')" class="nav-button">Volume</button>
      <button onclick="navigateTo('/liquidity')" class="nav-button">Liquidity</button>
      <button onclick="navigateTo('/flow')" class="nav-button">Flow</button>
      <button onclick="navigateTo('/accumulation')" class="nav-button">Accumulation</button>
      <button onclick="navigateTo('/delta')" class="nav-button">Delta</button>
      <button onclick="navigateTo('/signal')" class="nav-button">Signal</button>
      <button onclick="navigateTo('/data')" class="nav-button active">Data Table</button>
      <button onclick="navigateTo('/documentation')" class="nav-button">Docs</button>
    </div>
    
    <div class="controls">
      <select id="tickerSelect" class="ticker-select" onchange="changeTicker()">
        <option value="">Loading...</option>
      </select>
      
      <div class="date-nav">
        <button id="prevDate" class="date-arrow" onclick="changeDate(-1)" title="Previous Day">â—€</button>
        <div id="currentDate" class="date-display">Loading...</div>
        <button id="nextDate" class="date-arrow" onclick="changeDate(1)" title="Next Day">â–¶</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <div class="header">
      <div>
        <h1>ðŸ“Š Raw Data Table</h1>
        <div class="header-info" id="headerInfo">Loading data...</div>
      </div>
    </div>
    
    <div class="pagination">
      <button id="firstPage" onclick="goToPage(0)">First</button>
      <button id="prevPage" onclick="changePage(-1)">Previous</button>
      <span style="color: #888;" id="pageInfo">Page 1</span>
      <button id="nextPage" onclick="changePage(1)">Next</button>
      <button id="lastPage" onclick="goToLastPage()">Last</button>
      <select id="pageSizeSelect" onchange="changePageSize()">
        <option value="50">50 rows</option>
        <option value="100" selected>100 rows</option>
        <option value="250">250 rows</option>
        <option value="500">500 rows</option>
      </select>
    </div>
    
    <div class="table-wrapper">
      <table id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody">
          <tr><td colspan="100" class="loading">Loading data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let currentSymbol = "{{ symbol }}";
    let availableDates = [];
    let currentDateIndex = 0;
    let currentPage = 0;
    let pageSize = 100;
    let totalRecords = 0;

    function formatDate(dateInt) {
      const str = String(dateInt);
      const year = str.substring(0, 4);
      const month = str.substring(4, 6);
      const day = str.substring(6, 8);
      return `${month}/${day}/${year}`;
    }

    function navigateTo(path) {
      const date = availableDates[currentDateIndex];
      const url = `${path}?symbol=${currentSymbol}${date ? '&date=' + date : ''}`;
      window.location.href = url;
    }

    async function loadTickers() {
      try {
        const response = await fetch('/api/symbols');
        const tickers = await response.json();
        const select = document.getElementById('tickerSelect');
        select.innerHTML = '';
        tickers.forEach(ticker => {
          const option = document.createElement('option');
          option.value = ticker;
          option.text = ticker;
          if (ticker === currentSymbol) option.selected = true;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading tickers:', error);
      }
    }

    async function loadDates() {
      try {
        const response = await fetch(`/api/dates?symbol=${currentSymbol}`);
        const data = await response.json();
        availableDates = data.dates || [];
        currentDateIndex = 0;
        if (availableDates.length > 0) {
          document.getElementById('currentDate').innerText = formatDate(availableDates[currentDateIndex]);
          updateDateButtons();
          loadData();
        }
      } catch (error) {
        console.error('Error loading dates:', error);
      }
    }

    function updateDateButtons() {
      document.getElementById('prevDate').disabled = currentDateIndex >= availableDates.length - 1;
      document.getElementById('nextDate').disabled = currentDateIndex <= 0;
    }

    function changeDate(direction) {
      currentDateIndex -= direction;
      if (currentDateIndex < 0) currentDateIndex = 0;
      if (currentDateIndex >= availableDates.length) currentDateIndex = availableDates.length - 1;
      document.getElementById('currentDate').innerText = formatDate(availableDates[currentDateIndex]);
      updateDateButtons();
      currentPage = 0;
      loadData();
    }

    function changeTicker() {
      const select = document.getElementById('tickerSelect');
      currentSymbol = select.value;
      currentPage = 0;
      loadDates();
    }

    async function loadData() {
      const date = availableDates[currentDateIndex];
      const offset = currentPage * pageSize;
      
      try {
        const url = `/api/raw-data?symbol=${currentSymbol}&date=${date}&limit=${pageSize}&offset=${offset}`;
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.s === 'ok' && result.data.length > 0) {
          totalRecords = result.total;
          displayData(result.data, result.columns);
          updatePagination();
          updateHeaderInfo();
        } else {
          document.getElementById('tableBody').innerHTML = '<tr><td colspan="100" class="loading">No data available</td></tr>';
        }
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="100" class="loading">Error loading data</td></tr>';
      }
    }

    function displayData(data, columns) {
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tableBody');
      
      // Create header
      thead.innerHTML = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
      
      // Create rows
      tbody.innerHTML = data.map(row => {
        return '<tr>' + columns.map(col => {
          let value = row[col];
          let className = '';
          
          // Format numbers
          if (typeof value === 'number') {
            className = 'number';
            if (col.includes('Price') || col.includes('Spread')) {
              value = value.toFixed(4);
            } else if (col.includes('Volume') || col.includes('Size') || col.includes('Trade')) {
              value = value.toLocaleString();
            } else {
              value = value.toFixed(2);
            }
            
            // Color code positive/negative
            if (value > 0) className += ' positive';
            else if (value < 0) className += ' negative';
          } else if (value === null) {
            value = '-';
            className = 'neutral';
          }
          
          return `<td class="${className}">${value}</td>`;
        }).join('') + '</tr>';
      }).join('');
    }

    function updatePagination() {
      const totalPages = Math.ceil(totalRecords / pageSize);
      document.getElementById('pageInfo').innerText = `Page ${currentPage + 1} of ${totalPages} (${totalRecords.toLocaleString()} rows)`;
      document.getElementById('prevPage').disabled = currentPage === 0;
      document.getElementById('firstPage').disabled = currentPage === 0;
      document.getElementById('nextPage').disabled = currentPage >= totalPages - 1;
      document.getElementById('lastPage').disabled = currentPage >= totalPages - 1;
    }

    function updateHeaderInfo() {
      const date = formatDate(availableDates[currentDateIndex]);
      document.getElementById('headerInfo').innerText = `${currentSymbol} - ${date} - Showing ${totalRecords.toLocaleString()} records`;
    }

    function changePage(direction) {
      currentPage += direction;
      loadData();
    }

    function goToPage(page) {
      currentPage = page;
      loadData();
    }

    function goToLastPage() {
      currentPage = Math.ceil(totalRecords / pageSize) - 1;
      loadData();
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      currentPage = 0;
      loadData();
    }

    // Initialize
    loadTickers();
    loadDates();
  </script>
</body>
</html>
