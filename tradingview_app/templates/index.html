<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TradingView DuckDB Viewer</title>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <style>
    html, body { margin: 0; height: 100%; background: #0e1117; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    #chart_container { width: 100%; height: calc(100vh - 70px); margin-top: 70px; }
    
    .nav { 
      position: fixed; top: 0; left: 0; right: 0; 
      background: rgba(14, 17, 23, 0.95); 
      padding: 12px 20px; 
      z-index: 1000; 
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid #2a2a2a;
    }
    
    .nav-tabs { display: flex; gap: 8px; }
    .nav-button { 
      color: #fff; 
      background: #2a2a2a; 
      border: none; 
      padding: 8px 14px; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 13px;
      transition: all 0.2s;
    }
    .nav-button:hover { background: #3a3a3a; }
    .nav-button.active { background: #00d4aa; color: #000; }
    
    .controls { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-left: auto;
    }
    
    .ticker-select, .date-display {
      background: #1a1a2e;
      border: 1px solid #333;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .ticker-select { min-width: 120px; cursor: pointer; }
    .ticker-select:focus { outline: none; border-color: #00d4aa; }
    
    .date-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-arrow {
      background: #2a2a2a;
      border: none;
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .date-arrow:hover { background: #00d4aa; color: #000; }
    .date-arrow:disabled { opacity: 0.3; cursor: not-allowed; }
    
    .date-display {
      min-width: 100px;
      text-align: center;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-tabs">
      <button onclick="navigateTo('/spread')" class="nav-button">Spread</button>
      <button onclick="navigateTo('/vwap')" class="nav-button" style="background: #4CAF50;">VWAP</button>
      <button onclick="navigateTo('/volume')" class="nav-button" style="background: #FF9800;">Volume</button>
      <button onclick="navigateTo('/liquidity')" class="nav-button" style="background: #9C27B0;">Liquidity</button>
      <button onclick="navigateTo('/flow')" class="nav-button" style="background: #00BCD4;">Flow</button>
      <button onclick="navigateTo('/accumulation')" class="nav-button" style="background: #E91E63;">Accumulation</button>
      <button onclick="navigateTo('/delta')" class="nav-button" style="background: #E91E63;">Delta</button>
      <button onclick="navigateTo('/signal')" class="nav-button" style="background: #FF5722;">Signal</button>
      <button onclick="navigateTo('/documentation')" class="nav-button" style="background: #607D8B;">Docs</button>
      <button onclick="navigateTo('/data')" class="nav-button" style="background: #FFC107;">Data Table</button>
    </div>
    
    <div class="controls">
      <select id="timeframeSelect" class="ticker-select" onchange="changeTimeframe()" style="min-width: 90px;">
        <option value="1min">1-Min</option>
        <option value="daily">Daily</option>
      </select>
      
      <select id="tickerSelect" class="ticker-select" onchange="changeTicker()">
        <option value="">Loading...</option>
      </select>
      
      <div class="date-nav">
        <button id="prevDate" class="date-arrow" onclick="changeDate(-1)" title="Previous Day">â—€</button>
        <div id="currentDate" class="date-display">Loading...</div>
        <button id="nextDate" class="date-arrow" onclick="changeDate(1)" title="Next Day">â–¶</button>
      </div>
    </div>
  </div>
  
  <div id="chart_container"></div>
  
  <!-- Spread Info Panel -->
  <div id="spread-info" style="position: absolute; top: 90px; right: 20px; background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 13px; z-index: 1000; border: 1px solid #333;">
    <div style="color: #00d4aa; font-weight: bold; margin-bottom: 8px;">ðŸ“Š Live Spread Data</div>
    <div id="min-spread" style="color: #00FF88;">Min: Loading...</div>
    <div id="max-spread" style="color: #FF4444;">Max: Loading...</div>
    <div id="avg-spread" style="color: #FFD700;">Avg: Loading...</div>
    <div style="margin-top: 8px; font-size: 11px; color: #888;">
      <span onclick="toggleSpreadInfo()" style="cursor: pointer; color: #00d4aa;">[Hide]</span>
    </div>
  </div>

  <script>
    let currentSymbol = "{{ symbol }}";
    let currentTimeframe = "{{ timeframe }}";
    let availableDates = [];
    let currentDateIndex = 0;
    let widget = null;
    
    // Set timeframe selector on page load
    document.addEventListener('DOMContentLoaded', () => {
      const timeframeSelect = document.getElementById('timeframeSelect');
      if (timeframeSelect && currentTimeframe) {
        timeframeSelect.value = currentTimeframe;
      }
    });

    // Format date from YYYYMMDD to readable format
    function formatDate(dateInt) {
      const str = String(dateInt);
      const year = str.substring(0, 4);
      const month = str.substring(4, 6);
      const day = str.substring(6, 8);
      return `${month}/${day}/${year}`;
    }

    // Navigate to a page with current symbol and date
    function navigateTo(path) {
      const date = availableDates[currentDateIndex];
      const url = `${path}?symbol=${currentSymbol}${date ? '&date=' + date : ''}`;
      window.location.href = url;
    }

    // Load available tickers
    async function loadTickers() {
      try {
        const response = await fetch('/api/symbols');
        const tickers = await response.json();
        const select = document.getElementById('tickerSelect');
        select.innerHTML = tickers.map(t => 
          `<option value="${t}" ${t === currentSymbol ? 'selected' : ''}>${t}</option>`
        ).join('');
      } catch (error) {
        console.error('Error loading tickers:', error);
      }
    }

    // Load available dates for current ticker
    async function loadDates() {
      try {
        const response = await fetch(`/api/dates?symbol=${currentSymbol}`);
        const data = await response.json();
        availableDates = data.dates || [];
        currentDateIndex = 0; // Start with most recent date
        updateDateDisplay();
      } catch (error) {
        console.error('Error loading dates:', error);
      }
    }

    // Update date display and arrow states
    function updateDateDisplay() {
      const dateDisplay = document.getElementById('currentDate');
      const prevBtn = document.getElementById('prevDate');
      const nextBtn = document.getElementById('nextDate');
      
      if (availableDates.length === 0) {
        dateDisplay.textContent = 'No data';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      
      dateDisplay.textContent = formatDate(availableDates[currentDateIndex]);
      prevBtn.disabled = currentDateIndex >= availableDates.length - 1;
      nextBtn.disabled = currentDateIndex <= 0;
    }

    // Change date (direction: -1 for previous, 1 for next)
    function changeDate(direction) {
      const newIndex = currentDateIndex - direction; // Reversed because dates are DESC
      if (newIndex >= 0 && newIndex < availableDates.length) {
        currentDateIndex = newIndex;
        updateDateDisplay();
        reloadData();
      }
    }

    // Change ticker
    function changeTicker() {
      const select = document.getElementById('tickerSelect');
      currentSymbol = select.value;
      loadDates().then(() => reloadData());
    }
    
    // Change timeframe
    function changeTimeframe() {
      const timeframe = document.getElementById('timeframeSelect').value;
      const date = availableDates[currentDateIndex];
      window.location.href = `/?symbol=${currentSymbol}${date ? '&date=' + date : ''}&timeframe=${timeframe}`;
    }

    // Reload data with current symbol and date
    function reloadData() {
      const date = availableDates[currentDateIndex];
      // Update URL without reload
      const newUrl = `/?symbol=${currentSymbol}${date ? '&date=' + date : ''}`;
      window.history.replaceState({}, '', newUrl);
      
      // Reload spread data
      loadSpreadData();
      
      // Recreate chart if needed
      if (widget) {
        initChart();
      }
    }

    // Load spread data
    async function loadSpreadData() {
      const date = availableDates[currentDateIndex];
      const timeframe = document.getElementById('timeframeSelect')?.value || '1min';
      const url = `/api/spread?symbol=${currentSymbol}${date ? '&date=' + date : ''}&timeframe=${timeframe}`;
      
      try {
        const response = await fetch(url);
        const spreadData = await response.json();
        
        if (spreadData.s === "ok" && spreadData.min_spread && spreadData.min_spread.length > 0) {
          const minSpread = Math.min(...spreadData.min_spread);
          const maxSpread = Math.max(...spreadData.max_spread);
          const avgSpread = (spreadData.min_spread.reduce((a, b) => a + b, 0) + 
                           spreadData.max_spread.reduce((a, b) => a + b, 0)) / 
                          (spreadData.min_spread.length * 2);
          
          document.getElementById('min-spread').textContent = `Min: $${minSpread.toFixed(4)}`;
          document.getElementById('max-spread').textContent = `Max: $${maxSpread.toFixed(4)}`;
          document.getElementById('avg-spread').textContent = `Avg: $${avgSpread.toFixed(4)}`;
        }
      } catch (error) {
        console.error('Error loading spread data:', error);
      }
    }

    // Initialize chart
    function initChart() {
      const container = document.getElementById('chart_container');
      container.innerHTML = '';
      
      widget = new TradingView.widget({
        container_id: "chart_container",
        autosize: true,
        symbol: currentSymbol,
        interval: "1",
        theme: "dark",
        datafeed: {
          onReady: cb => cb({ supports_time: true }),
          resolveSymbol: (symbolName, onSymbolResolvedCallback) => {
            onSymbolResolvedCallback({
              name: symbolName,
              ticker: symbolName,
              type: "stock",
              session: "24x7",
              timezone: "Etc/UTC",
              pricescale: 100,
              has_intraday: true,
              has_no_volume: false,
            });
          },
          getBars: async (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) => {
            const date = availableDates[currentDateIndex];
            const url = `/api/history?symbol=${symbolInfo.name}&resolution=${resolution}${date ? '&date=' + date : ''}`;
            
            try {
              const response = await fetch(url);
              const data = await response.json();
              if (data.s !== "ok" || !data.t) { 
                onHistoryCallback([], { noData: true }); 
                return; 
              }
              const bars = data.t.map((t, i) => ({
                time: t * 1000,
                open: data.o[i],
                high: data.h[i],
                low: data.l[i],
                close: data.c[i],
                volume: data.v[i],
              }));
              onHistoryCallback(bars, { noData: false });
            } catch (error) {
              console.error('Error fetching bars:', error);
              onHistoryCallback([], { noData: true });
            }
          },
          subscribeBars: () => {},
          unsubscribeBars: () => {},
        },
        overrides: {
          "paneProperties.background": "#131722",
          "paneProperties.vertGridProperties.color": "#363c4e",
          "paneProperties.horzGridProperties.color": "#363c4e",
          "scalesProperties.textColor": "#AAA",
        },
        loading_screen: { backgroundColor: "#131722" },
      });
    }

    // Toggle spread info panel
    function toggleSpreadInfo() {
      const panel = document.getElementById('spread-info');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadTickers();
      await loadDates();
      initChart();
      loadSpreadData();
    });
  </script>
</body>
</html>