<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TradingView DuckDB Viewer</title>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <style>
    html, body { margin: 0; height: 100%; background: #0e1117; }
    #chart_container { width: 100%; height: calc(100vh - 60px); }
    .nav { position: fixed; top: 0; left: 0; right: 0; background: rgba(14, 17, 23, 0.9); padding: 15px 20px; z-index: 1000; backdrop-filter: blur(10px); }
    .nav a { color: #00d4aa; text-decoration: none; margin-right: 20px; padding: 8px 15px; background: rgba(42, 42, 42, 0.8); border-radius: 4px; font-size: 14px; }
    .nav a:hover { background: rgba(58, 58, 58, 0.8); }
    #chart_container { margin-top: 60px; }
  </style>
</head>
<body>
        <div class="nav-tabs">
        <button onclick="window.location.href='/'" class="nav-button active">Chart</button>
        <button onclick="window.location.href='/spread?symbol=AAPL'" class="nav-button">Spread Analysis</button>
        <button onclick="window.location.href='/vwap?symbol=AAPL'" class="nav-button" style="background: #4CAF50;">VWAP Analysis</button>
        <button onclick="window.location.href='/volume?symbol=AAPL'" class="nav-button" style="background: #FF9800;">Volume Analysis</button>
        <button onclick="window.location.href='/liquidity?symbol=AAPL'" class="nav-button" style="background: #9C27B0;">Liquidity Analysis</button>
        <button onclick="window.location.href='/flow?symbol=AAPL'" class="nav-button" style="background: #00BCD4;">Order Flow</button>
      </div>
  <div id="chart_container"></div>
  
  <!-- Spread Info Panel -->
  <div id="spread-info" style="position: absolute; top: 80px; right: 20px; background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 13px; z-index: 1000; border: 1px solid #333;">
    <div style="color: #00d4aa; font-weight: bold; margin-bottom: 8px;">üìä Live Spread Data</div>
    <div id="min-spread" style="color: #00FF88;">Min: Loading...</div>
    <div id="max-spread" style="color: #FF4444;">Max: Loading...</div>
    <div id="avg-spread" style="color: #FFD700;">Avg: Loading...</div>
    <div style="margin-top: 8px; font-size: 11px; color: #888;">
      <span onclick="toggleSpreadInfo()" style="cursor: pointer; color: #00d4aa;">[Hide]</span>
    </div>
  </div>

  <script>
    const symbol = "{{ symbol }}";

    const widget = new TradingView.widget({
      container_id: "chart_container",
      autosize: true,
      symbol: symbol,
      interval: "1",
      theme: "dark",
      datafeed: {
        onReady: cb => cb({ supports_time: true }),
        resolveSymbol: (symbolName, onSymbolResolvedCallback) => {
          // Handle spread overlay symbols
          if (symbolName.includes('_SPREAD_')) {
            onSymbolResolvedCallback({
              name: symbolName,
              ticker: symbolName,
              type: "line",
              session: "24x7",
              timezone: "Etc/UTC",
              pricescale: 10000,
              has_intraday: true,
              has_no_volume: true,
            });
            return;
          }
          
          // Regular stock symbol
          onSymbolResolvedCallback({
            name: symbolName,
            ticker: symbolName,
            type: "stock",
            session: "24x7",
            timezone: "Etc/UTC",
            pricescale: 100,
            has_intraday: true,
            has_no_volume: false,
          });
        },
        getBars: async (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) => {
          const from = periodParams.from;
          const to = periodParams.to;
          
          // Handle different symbols for overlays
          if (symbolInfo.name.includes('_SPREAD_')) {
            // This is a spread overlay request
            const baseSymbol = symbolInfo.name.split('_SPREAD_')[0];
            const spreadType = symbolInfo.name.split('_SPREAD_')[1]; // MIN or MAX
            
            const spreadResponse = await fetch(`/api/spread?symbol=${baseSymbol}`);
            const spreadData = await spreadResponse.json();
            
            if (spreadData.s !== "ok") { 
              onHistoryCallback([], { noData: true }); 
              return; 
            }
            
            const spreadBars = spreadData.t.map((t, i) => {
              const spreadValue = spreadType === 'MIN' ? spreadData.min_spread[i] : spreadData.max_spread[i];
              return {
                time: t * 1000,
                open: spreadValue,
                high: spreadValue,
                low: spreadValue,
                close: spreadValue,
                volume: 0,
              };
            });
            
            onHistoryCallback(spreadBars, { noData: false });
            return;
          }
          
          // Handle VWAP and other indicators
          if (symbolInfo.name.includes('_VWAP') || symbolInfo.name.includes('_TRADES')) {
            const baseSymbol = symbolInfo.name.split('_')[0];
            const indicatorType = symbolInfo.name.split('_')[1]; // VWAP, TRADES, etc.
            
            const indicatorResponse = await fetch(`/api/indicators?symbol=${baseSymbol}`);
            const indicatorData = await indicatorResponse.json();
            
            if (indicatorData.s !== "ok") { 
              onHistoryCallback([], { noData: true }); 
              return; 
            }
            
            let indicatorBars;
            if (indicatorType === 'VWAP') {
              indicatorBars = indicatorData.t.map((t, i) => ({
                time: t * 1000,
                open: indicatorData.vwap[i],
                high: indicatorData.vwap[i],
                low: indicatorData.vwap[i],
                close: indicatorData.vwap[i],
                volume: 0,
              }));
            } else if (indicatorType === 'TRADES') {
              indicatorBars = indicatorData.t.map((t, i) => ({
                time: t * 1000,
                open: indicatorData.total_trades[i],
                high: indicatorData.total_trades[i],
                low: indicatorData.total_trades[i],
                close: indicatorData.total_trades[i],
                volume: 0,
              }));
            }
            
            onHistoryCallback(indicatorBars, { noData: false });
            return;
          }
          
          // Regular price data
          const url = `/api/history?symbol=${symbolInfo.name}&resolution=${resolution}&from_=${from}&to=${to}`;
          const response = await fetch(url);
          const data = await response.json();
          if (data.s !== "ok") { onHistoryCallback([], { noData: true }); return; }
          const bars = data.t.map((t, i) => ({
            time: t * 1000,
            open: data.o[i],
            high: data.h[i],
            low: data.l[i],
            close: data.c[i],
            volume: data.v[i],
          }));
          onHistoryCallback(bars, { noData: false });
        },
      },
      studies_overrides: {
        "volume.volume.color.0": "#00FFFF",
        "volume.volume.color.1": "#0000FF",
      },
      overrides: {
        "paneProperties.background": "#131722",
        "paneProperties.vertGridProperties.color": "#363c4e",
        "paneProperties.horzGridProperties.color": "#363c4e",
        "symbolWatermarkProperties.transparency": 90,
        "scalesProperties.textColor": "#AAA",
      },
      loading_screen: { backgroundColor: "#131722" },
      onChartReady: () => {
        console.log("üìà TradingView chart is ready!");
      }
    });

    // Load spread data immediately, don't wait for TradingView
    setTimeout(async () => {
          // Update panel to show loading status
          document.getElementById('min-spread').textContent = 'Min: Fetching...';
          document.getElementById('max-spread').textContent = 'Max: Fetching...';
          document.getElementById('avg-spread').textContent = 'Avg: Fetching...';
          
          try {
            console.log(`üîÑ Loading spread data for ${symbol}...`);
            
            const spreadResponse = await fetch(`/api/spread?symbol=${symbol}`, {
              method: 'GET',
              headers: {'Accept': 'application/json'},
              timeout: 5000
            });
            console.log('‚úÖ Spread response status:', spreadResponse.status);
            
            if (!spreadResponse.ok) {
              throw new Error(`HTTP ${spreadResponse.status}: ${spreadResponse.statusText}`);
            }
            
            const spreadData = await spreadResponse.json();
            console.log('Spread data received:', spreadData);
            
            if (spreadData.s === "ok") {
              // Calculate statistics
              const minSpread = Math.min(...spreadData.min_spread);
              const maxSpread = Math.max(...spreadData.max_spread);
              const avgMinSpread = spreadData.min_spread.reduce((a, b) => a + b, 0) / spreadData.min_spread.length;
              const avgMaxSpread = spreadData.max_spread.reduce((a, b) => a + b, 0) / spreadData.max_spread.length;
              const avgSpread = (avgMinSpread + avgMaxSpread) / 2;
              
              // Update info panel
              document.getElementById('min-spread').textContent = `Min: $${minSpread.toFixed(4)}`;
              document.getElementById('max-spread').textContent = `Max: $${maxSpread.toFixed(4)}`;
              document.getElementById('avg-spread').textContent = `Avg: $${avgSpread.toFixed(4)}`;
              
              console.log("üìä Spread Statistics:");
              console.log(`   Min Spread: $${minSpread.toFixed(4)}`);
              console.log(`   Max Spread: $${maxSpread.toFixed(4)}`);
              console.log(`   Avg Spread: $${avgSpread.toFixed(4)}`);
              
              // Try to add overlays (may not work in free version)
              try {
                widget.chart().createStudy('Compare', false, false, [`${symbol}_SPREAD_MIN`]);
                widget.chart().createStudy('Compare', false, false, [`${symbol}_SPREAD_MAX`]);
                console.log("‚úÖ Spread overlays attempted");
              } catch (overlayError) {
                console.log("‚ÑπÔ∏è Spread overlays not supported in this TradingView version");
                console.log("üí° Use the 'Spread Analysis' tab for detailed charts");
              }
              
              // Also try VWAP and trades overlays
              try {
                widget.chart().createStudy('Compare', false, false, [`${symbol}_VWAP`]);
                widget.chart().createStudy('Compare', false, false, [`${symbol}_TRADES`]);
                console.log("‚úÖ VWAP and Trades overlays attempted");
              } catch (overlayError) {
                console.log("‚ÑπÔ∏è Additional overlays not supported in this TradingView version");
              }
              
            }
          } catch (error) {
            console.error("‚ùå Error loading spread data:", error);
            document.getElementById('spread-info').innerHTML = `
              <div style="color: #ff4444;">‚ùå Error Loading Spread</div>
              <div style="font-size: 10px; color: #888;">${error.message}</div>
              <div style="font-size: 10px; color: #888; margin-top: 4px;">
                <a href="/spread?symbol=${symbol}" style="color: #00d4aa;">View Spread Page ‚Üí</a>
              </div>
            `;
          }
        }, 1000); // Reduced from 2000ms to 1000ms

    // Manual overlay functions
    function addVWAPOverlay() {
      try {
        const symbol = 'AAPL'; // You can make this dynamic
        widget.chart().createStudy('Compare', false, false, [`${symbol}_VWAP`]);
        console.log("‚úÖ VWAP overlay added manually");
      } catch (error) {
        console.log("‚ÑπÔ∏è VWAP overlay not supported in free TradingView version");
        console.log("‚ùå VWAP overlay error:", error);
      }
    }
    
    function addTradesOverlay() {
      try {
        const symbol = 'AAPL'; // You can make this dynamic  
        widget.chart().createStudy('Compare', false, false, [`${symbol}_TRADES`]);
        console.log("‚úÖ Trades overlay added manually");
      } catch (error) {
        console.log("‚ÑπÔ∏è Trades overlay not supported in free TradingView version");
        console.log("‚ùå Trades overlay error:", error);
      }
    }

    // Toggle spread info panel
    function toggleSpreadInfo() {
      const panel = document.getElementById('spread-info');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
      } else {
        panel.style.display = 'none';
      }
    }
  </script>
</body>
</html>