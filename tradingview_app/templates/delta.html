<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta & Momentum - Scanner WebApp</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; 
            padding: 20px; 
            padding-top: 80px;
            background: #0f0f23; 
            color: white; 
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid #333;
        }
        .nav-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-button {
            background: #1a1a3e;
            color: #00d4aa;
            border: none;
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
        }
        .nav-button:hover { background: #2a2a4e; }
        .nav-button.active { background: #E91E63; color: white; }
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .ticker-select, .date-display {
            background: #1a1a2e;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .ticker-select { min-width: 100px; cursor: pointer; }
        .ticker-select:focus { outline: none; border-color: #E91E63; }
        .date-nav { display: flex; align-items: center; gap: 6px; }
        .date-arrow {
            background: #2a2a4e;
            border: none;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .date-arrow:hover { background: #E91E63; color: #fff; }
        .date-arrow:disabled { opacity: 0.3; cursor: not-allowed; }
        .date-display { min-width: 90px; text-align: center; font-weight: 500; }
        .chart-container { 
            background: #1a1a2e; 
            border-radius: 8px; 
            margin: 20px 0;
            min-height: 350px;
            width: 100%;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #1a1a3e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #E91E63;
        }
        .stat-value.bullish { color: #4CAF50; }
        .stat-value.bearish { color: #F44336; }
        .stat-value.neutral { color: #FFC107; }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        h1 { margin-top: 0; }
        .direction-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .direction-badge.up { background: #4CAF50; color: white; }
        .direction-badge.down { background: #F44336; color: white; }
        .direction-badge.neutral { background: #FFC107; color: black; }
        .delta-bar {
            height: 30px;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
            margin: 10px 0;
        }
        .delta-buy { background: #4CAF50; transition: width 0.3s; }
        .delta-sell { background: #F44336; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav-tabs">
            <button onclick="navigateTo('/')" class="nav-button">Chart</button>
            <button onclick="navigateTo('/spread')" class="nav-button">Spread</button>
            <button onclick="navigateTo('/vwap')" class="nav-button">VWAP</button>
            <button onclick="navigateTo('/volume')" class="nav-button">Volume</button>
            <button onclick="navigateTo('/liquidity')" class="nav-button">Liquidity</button>
            <button onclick="navigateTo('/flow')" class="nav-button">Flow</button>
            <button onclick="navigateTo('/accumulation')" class="nav-button">Accumulation</button>
            <button class="nav-button active">Delta</button>
            <button onclick="navigateTo('/signal')" class="nav-button">Signal</button>
            <button onclick="navigateTo('/documentation')" class="nav-button">Docs</button>
        </div>
        <div class="controls">
            <label style="display: flex; align-items: center; gap: 6px; color: #888; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="showPrice" onchange="togglePriceOverlay()" style="width: 16px; height: 16px; cursor: pointer;">
                Price Overlay
            </label>
            <select id="tickerSelect" class="ticker-select" onchange="changeTicker()">
                <option value="">Loading...</option>
            </select>
            <div class="date-nav">
                <button id="prevDate" class="date-arrow" onclick="changeDate(-1)">â—€</button>
                <div id="currentDate" class="date-display">Loading...</div>
                <button id="nextDate" class="date-arrow" onclick="changeDate(1)">â–¶</button>
            </div>
        </div>
    </div>

    <h1>ðŸ“Š Delta & Momentum Analysis</h1>

    <!-- Direction Summary -->
    <div class="stat-card" style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="font-size: 16px; font-weight: bold;">Current Direction</span>
                <div style="margin-top: 8px;">
                    <span id="direction-badge" class="direction-badge neutral">NEUTRAL</span>
                </div>
            </div>
            <div style="text-align: right;">
                <div class="stat-label">Cumulative Delta</div>
                <div id="cumulative-delta" class="stat-value">--</div>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <div class="stat-label">Buy vs Sell Volume</div>
            <div class="delta-bar">
                <div id="buy-bar" class="delta-buy" style="width: 50%;"></div>
                <div id="sell-bar" class="delta-sell" style="width: 50%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                <span id="buy-pct" style="color: #4CAF50;">Buy: 50%</span>
                <span id="sell-pct" style="color: #F44336;">Sell: 50%</span>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="delta-now">--</div>
            <div class="stat-label">Current Bar Delta</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="tick-delta">--</div>
            <div class="stat-label">Tick Delta</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="book-imbalance">--</div>
            <div class="stat-label">Book Imbalance</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="delta-pct">--</div>
            <div class="stat-label">Delta %</div>
        </div>
    </div>

    <div id="cumulative-chart" class="chart-container">
        <div style="display: flex; justify-content: center; align-items: center; height: 350px; color: #666;">Loading chart...</div>
    </div>
    <div id="delta-chart" class="chart-container">
        <div style="display: flex; justify-content: center; align-items: center; height: 350px; color: #666;">Loading chart...</div>
    </div>
    <div id="tick-chart" class="chart-container">
        <div style="display: flex; justify-content: center; align-items: center; height: 350px; color: #666;">Loading chart...</div>
    </div>

    <script>
        let currentSymbol = new URLSearchParams(window.location.search).get('symbol') || 'AMD';
        
        // Check if Plotly loaded
        if (typeof Plotly === 'undefined') {
            console.error('Plotly failed to load!');
            document.querySelectorAll('.chart-container').forEach(el => {
                el.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 350px; color: #f44336;">Error: Chart library failed to load.</div>';
            });
        }
        let availableDates = [];
        let currentDateIndex = 0;
        let lastData = null;

        function navigateTo(path) {
            const params = new URLSearchParams(window.location.search);
            window.location.href = path + '?' + params.toString();
        }

        async function loadSymbols() {
            const select = document.getElementById('tickerSelect');
            try {
                const response = await fetch('/api/symbols');
                const symbols = await response.json();
                select.innerHTML = symbols.map(s => 
                    `<option value="${s}" ${s === currentSymbol ? 'selected' : ''}>${s}</option>`
                ).join('');
            } catch (e) {
                console.error('Error loading symbols:', e);
            }
        }

        async function loadDates() {
            try {
                const response = await fetch(`/api/dates?symbol=${currentSymbol}`);
                const data = await response.json();
                availableDates = data.dates || [];
                currentDateIndex = 0;
                updateDateDisplay();
                loadData();
            } catch (e) {
                console.error('Error loading dates:', e);
            }
        }

        function updateDateDisplay() {
            const dateDisplay = document.getElementById('currentDate');
            if (availableDates.length > 0) {
                const date = availableDates[currentDateIndex];
                const year = Math.floor(date / 10000);
                const month = Math.floor((date % 10000) / 100);
                const day = date % 100;
                dateDisplay.textContent = `${month}/${day}/${year}`;
            }
            document.getElementById('prevDate').disabled = currentDateIndex >= availableDates.length - 1;
            document.getElementById('nextDate').disabled = currentDateIndex <= 0;
        }

        function changeDate(direction) {
            currentDateIndex -= direction;
            if (currentDateIndex < 0) currentDateIndex = 0;
            if (currentDateIndex >= availableDates.length) currentDateIndex = availableDates.length - 1;
            updateDateDisplay();
            loadData();
        }

        function changeTicker() {
            currentSymbol = document.getElementById('tickerSelect').value;
            const url = new URL(window.location);
            url.searchParams.set('symbol', currentSymbol);
            window.history.pushState({}, '', url);
            loadDates();
        }

        function togglePriceOverlay() {
            if (lastData) {
                renderCharts(lastData);
            }
        }

        function formatNumber(num) {
            if (Math.abs(num) >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (Math.abs(num) >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }

        async function loadData() {
            try {
                const date = availableDates[currentDateIndex];
                const response = await fetch(`/api/delta?symbol=${currentSymbol}&date=${date}`);
                const data = await response.json();
                
                if (data.s !== 'ok') {
                    console.error('No data available');
                    return;
                }

                lastData = data;
                renderCharts(data);
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function renderCharts(data) {
            if (typeof Plotly === 'undefined') {
                console.error('Plotly not loaded');
                return;
            }
            
            try {
                const showPrice = document.getElementById('showPrice').checked;
                const dates = data.t.map(t => new Date(t * 1000));
                const n = data.delta.length;
                
                if (n === 0) {
                    console.error('No data points');
                    return;
                }

            // Update stats
            const lastDelta = data.cumulative_delta[n - 1];
            const lastBarDelta = data.delta[n - 1];
            const lastTickDelta = data.tick_delta[n - 1];
            const lastBookImbalance = data.book_imbalance[n - 1];
            const lastDeltaPct = data.delta_pct[n - 1];

            document.getElementById('cumulative-delta').textContent = formatNumber(lastDelta);
            document.getElementById('cumulative-delta').className = 'stat-value ' + (lastDelta > 0 ? 'bullish' : lastDelta < 0 ? 'bearish' : 'neutral');
            
            document.getElementById('delta-now').textContent = formatNumber(lastBarDelta);
            document.getElementById('delta-now').className = 'stat-value ' + (lastBarDelta > 0 ? 'bullish' : lastBarDelta < 0 ? 'bearish' : 'neutral');
            
            document.getElementById('tick-delta').textContent = formatNumber(lastTickDelta);
            document.getElementById('tick-delta').className = 'stat-value ' + (lastTickDelta > 0 ? 'bullish' : lastTickDelta < 0 ? 'bearish' : 'neutral');
            
            document.getElementById('book-imbalance').textContent = lastBookImbalance.toFixed(1) + '%';
            document.getElementById('book-imbalance').className = 'stat-value ' + (lastBookImbalance > 5 ? 'bullish' : lastBookImbalance < -5 ? 'bearish' : 'neutral');
            
            document.getElementById('delta-pct').textContent = lastDeltaPct.toFixed(1) + '%';
            document.getElementById('delta-pct').className = 'stat-value ' + (lastDeltaPct > 0 ? 'bullish' : lastDeltaPct < 0 ? 'bearish' : 'neutral');

            // Direction badge
            const badge = document.getElementById('direction-badge');
            if (lastDelta > 10000) {
                badge.textContent = 'ðŸŸ¢ BULLISH';
                badge.className = 'direction-badge up';
            } else if (lastDelta < -10000) {
                badge.textContent = 'ðŸ”´ BEARISH';
                badge.className = 'direction-badge down';
            } else {
                badge.textContent = 'âšª NEUTRAL';
                badge.className = 'direction-badge neutral';
            }

            // Buy/Sell bar
            const totalBuy = data.buy_volume.reduce((a, b) => a + b, 0);
            const totalSell = data.sell_volume.reduce((a, b) => a + b, 0);
            const total = totalBuy + totalSell;
            const buyPct = total > 0 ? (totalBuy / total * 100) : 50;
            const sellPct = total > 0 ? (totalSell / total * 100) : 50;
            
            document.getElementById('buy-bar').style.width = buyPct + '%';
            document.getElementById('sell-bar').style.width = sellPct + '%';
            document.getElementById('buy-pct').textContent = `Buy: ${buyPct.toFixed(1)}%`;
            document.getElementById('sell-pct').textContent = `Sell: ${sellPct.toFixed(1)}%`;

            // Chart 1: Cumulative Delta
            const traces1 = [{
                x: dates,
                y: data.cumulative_delta,
                type: 'scatter',
                mode: 'lines',
                name: 'Cumulative Delta',
                fill: 'tozeroy',
                line: { color: '#E91E63', width: 2 },
                fillcolor: 'rgba(233, 30, 99, 0.3)'
            }];
            
            if (showPrice && data.last_price) {
                traces1.push({
                    x: dates,
                    y: data.last_price,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Price',
                    yaxis: 'y2',
                    line: { color: '#FFD700', width: 2 }
                });
            }

            const layout1 = {
                title: 'Cumulative Delta (Buy - Sell Volume)',
                xaxis: { title: '' },
                yaxis: { title: 'Cumulative Delta', side: 'left' },
                plot_bgcolor: '#1a1a2e',
                paper_bgcolor: '#1a1a2e',
                font: { color: '#fff' },
                margin: { t: 40, r: showPrice ? 60 : 30, b: 40, l: 60 }
            };
            if (showPrice) {
                layout1.yaxis2 = { title: 'Price', side: 'right', overlaying: 'y' };
            }
            Plotly.newPlot('cumulative-chart', traces1, layout1, {responsive: true});

            // Chart 2: Bar Delta
            const deltaColors = data.delta.map(d => d >= 0 ? '#4CAF50' : '#F44336');
            const traces2 = [{
                x: dates,
                y: data.delta,
                type: 'bar',
                name: 'Delta',
                marker: { color: deltaColors }
            }];

            if (showPrice && data.last_price) {
                traces2.push({
                    x: dates,
                    y: data.last_price,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Price',
                    yaxis: 'y2',
                    line: { color: '#FFD700', width: 2 }
                });
            }

            const layout2 = {
                title: 'Per-Bar Delta',
                xaxis: { title: '' },
                yaxis: { title: 'Delta', side: 'left' },
                plot_bgcolor: '#1a1a2e',
                paper_bgcolor: '#1a1a2e',
                font: { color: '#fff' },
                margin: { t: 40, r: showPrice ? 60 : 30, b: 40, l: 60 },
                bargap: 0.1
            };
            if (showPrice) {
                layout2.yaxis2 = { title: 'Price', side: 'right', overlaying: 'y' };
            }
            Plotly.newPlot('delta-chart', traces2, layout2, {responsive: true});

            // Chart 3: Tick Delta
            const traces3 = [{
                x: dates,
                y: data.cumulative_tick_delta,
                type: 'scatter',
                mode: 'lines',
                name: 'Cumulative Tick Delta',
                fill: 'tozeroy',
                line: { color: '#9C27B0', width: 2 },
                fillcolor: 'rgba(156, 39, 176, 0.3)'
            }];

            if (showPrice && data.last_price) {
                traces3.push({
                    x: dates,
                    y: data.last_price,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Price',
                    yaxis: 'y2',
                    line: { color: '#FFD700', width: 2 }
                });
            }

            const layout3 = {
                title: 'Cumulative Tick Delta (Uptick - Downtick Volume)',
                xaxis: { title: '' },
                yaxis: { title: 'Tick Delta', side: 'left' },
                plot_bgcolor: '#1a1a2e',
                paper_bgcolor: '#1a1a2e',
                font: { color: '#fff' },
                margin: { t: 40, r: showPrice ? 60 : 30, b: 40, l: 60 }
            };
            if (showPrice) {
                layout3.yaxis2 = { title: 'Price', side: 'right', overlaying: 'y' };
            }
            Plotly.newPlot('tick-chart', traces3, layout3, {responsive: true});
            
            } catch (err) {
                console.error('Error rendering charts:', err);
            }
        }

        // Initialize
        loadSymbols();
        loadDates();
    </script>
</body>
</html>
