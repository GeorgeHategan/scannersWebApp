<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Analysis - Scanner WebApp</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #0f0f23; 
            color: white; 
        }
        .nav-tabs {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        .nav-button {
            background: #1a1a3e;
            color: #00d4aa;
            border: none;
            padding: 10px 20px;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
        }
        .nav-button:hover { background: #2a2a4e; }
        .nav-button.active { background: #FF9800; color: white; }
        .chart-container { 
            background: white; 
            border-radius: 8px; 
            margin: 20px 0;
            height: 500px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #1a1a3e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FF9800;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üìä Volume & Trading Analysis</h1>
    
    <div class="nav-tabs">
        <button onclick="window.location.href='/'" class="nav-button">Chart</button>
        <button onclick="window.location.href='/spread?symbol=AAPL'" class="nav-button">Spread Analysis</button>
        <button onclick="window.location.href='/vwap?symbol=AAPL'" class="nav-button">VWAP Analysis</button>
        <button class="nav-button active">Volume Analysis</button>
        <button onclick="window.location.href='/liquidity?symbol=AAPL'" class="nav-button">Liquidity Analysis</button>
        <button onclick="window.location.href='/flow?symbol=AAPL'" class="nav-button">Order Flow</button>
    </div>

    <div class="stats-grid" id="stats-container">
        <div class="stat-card">
            <div class="stat-value" id="total-volume">Loading...</div>
            <div class="stat-label">Total Volume</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="aggression-ratio">Loading...</div>
            <div class="stat-label">Aggression Ratio</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="momentum-score">Loading...</div>
            <div class="stat-label">Momentum Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="algo-flow">Loading...</div>
            <div class="stat-label">Algo Flow %</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="uptick-conviction">Loading...</div>
            <div class="stat-label">Uptick Conviction</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="repeat-momentum">Loading...</div>
            <div class="stat-label">Repeat Momentum</div>
        </div>
    </div>

    <div class="chart-container" id="volume-chart"></div>
    <div class="chart-container" id="tick-chart"></div>

    <script>
        async function loadVolumeData() {
            try {
                console.log('üîÑ Loading volume data...');
                const response = await fetch('/api/volume?symbol={{ symbol }}');
                const data = await response.json();
                
                if (data.s !== "ok") {
                    throw new Error('No volume data available');
                }

                // Convert timestamps to dates
                const dates = data.t.map(timestamp => new Date(timestamp * 1000));
                
                // Calculate advanced microstructure statistics
                const totalVolume = data.volume.reduce((a, b) => a + b, 0);
                const totalUptick = data.uptick_volume.reduce((a, b) => a + b, 0);
                const totalDowntick = data.downtick_volume.reduce((a, b) => a + b, 0);
                const totalRepeatUptick = data.repeat_uptick.reduce((a, b) => a + b, 0);
                const totalRepeatDowntick = data.repeat_downtick.reduce((a, b) => a + b, 0);
                
                // Aggression Ratio - Short-term directional conviction
                const aggressionRatio = ((totalUptick / (totalUptick + totalDowntick)) * 100).toFixed(1);
                
                // Momentum Score - Net directional pressure
                const momentumScore = ((totalUptick - totalDowntick) / totalVolume * 100).toFixed(2);
                
                // Algorithmic Flow Detection - Repeat vs fresh momentum
                const totalRepeat = totalRepeatUptick + totalRepeatDowntick;
                const algoFlow = ((totalRepeat / totalVolume) * 100).toFixed(1);
                
                // Uptick Conviction - Strength of buying pressure
                const uptickConviction = (totalUptick / (totalVolume / 2) * 100).toFixed(1);
                
                // Repeat Momentum - Algorithmic persistence
                const repeatMomentum = ((totalRepeatUptick - totalRepeatDowntick) / totalRepeat * 100).toFixed(1);

                // Update statistics
                document.getElementById('total-volume').textContent = totalVolume.toLocaleString();
                document.getElementById('aggression-ratio').textContent = `${aggressionRatio}%`;
                document.getElementById('momentum-score').textContent = `${momentumScore}%`;
                document.getElementById('algo-flow').textContent = `${algoFlow}%`;
                document.getElementById('uptick-conviction').textContent = `${uptickConviction}%`;
                document.getElementById('repeat-momentum').textContent = `${repeatMomentum}%`;

                // Create volume chart
                const volumeTrace = {
                    x: dates,
                    y: data.volume,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Volume',
                    line: { color: '#FF9800', width: 2 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(255, 152, 0, 0.3)'
                };

                const tradesTrace = {
                    x: dates,
                    y: data.total_trades,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Trade Count',
                    line: { color: '#2196F3', width: 2 },
                    yaxis: 'y2'
                };

                const volumeLayout = {
                    title: 'Volume and Trade Activity',
                    paper_bgcolor: 'white',
                    plot_bgcolor: 'white',
                    font: { color: 'black' },
                    xaxis: { 
                        title: 'Time',
                        gridcolor: '#e6e6e6'
                    },
                    yaxis: { 
                        title: 'Volume',
                        gridcolor: '#e6e6e6'
                    },
                    yaxis2: {
                        title: 'Trade Count',
                        overlaying: 'y',
                        side: 'right',
                        gridcolor: '#e6e6e6'
                    },
                    margin: { t: 50, r: 70, b: 50, l: 50 },
                    hovermode: 'x unified'
                };

                Plotly.newPlot('volume-chart', [volumeTrace, tradesTrace], volumeLayout, {responsive: true});

                // Create tick direction chart
                const uptickTrace = {
                    x: dates,
                    y: data.uptick_volume,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Uptick Volume',
                    line: { color: '#4CAF50', width: 2 },
                    stackgroup: 'one'
                };

                const downtickTrace = {
                    x: dates,
                    y: data.downtick_volume.map(x => -x), // Make negative for visual effect
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Downtick Volume',
                    line: { color: '#F44336', width: 2 },
                    stackgroup: 'two'
                };

                const tickLayout = {
                    title: 'Uptick vs Downtick Volume',
                    paper_bgcolor: 'white',
                    plot_bgcolor: 'white',
                    font: { color: 'black' },
                    xaxis: { 
                        title: 'Time',
                        gridcolor: '#e6e6e6'
                    },
                    yaxis: { 
                        title: 'Volume (Downtick Negative)',
                        gridcolor: '#e6e6e6'
                    },
                    margin: { t: 50, r: 50, b: 50, l: 50 },
                    hovermode: 'x unified'
                };

                Plotly.newPlot('tick-chart', [uptickTrace, downtickTrace], tickLayout, {responsive: true});

                console.log('‚úÖ Volume analysis loaded successfully');
                console.log(`üìä Microstructure Metrics:`);
                console.log(`   Aggression Ratio: ${aggressionRatio}% | Momentum Score: ${momentumScore}%`);
                console.log(`   Algo Flow: ${algoFlow}% | Uptick Conviction: ${uptickConviction}%`);

            } catch (error) {
                console.error('‚ùå Error loading volume data:', error);
                document.getElementById('total-volume').textContent = 'Error';
                document.getElementById('total-trades').textContent = 'Error';
                document.getElementById('avg-trade-size').textContent = 'Error';
                document.getElementById('uptick-ratio').textContent = 'Error';
            }
        }

        // Load data when page loads
        window.addEventListener('DOMContentLoaded', loadVolumeData);
    </script>
</body>
</html>