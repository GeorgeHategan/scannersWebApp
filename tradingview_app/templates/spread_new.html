<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spread Analysis - Scanner WebApp</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #0f0f23; 
            color: white; 
        }
        .nav-tabs {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        .nav-button {
            background: #1a1a3e;
            color: #00d4aa;
            border: none;
            padding: 10px 20px;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
        }
        .nav-button:hover { background: #2a2a4e; }
        .nav-button.active { background: #00d4aa; color: #0f0f23; }
        .chart-container { 
            background: white; 
            border-radius: 8px; 
            margin: 20px 0;
            height: 500px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #1a1a3e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00d4aa;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üìä Bid-Ask Spread Analysis</h1>
    
    <div class="nav-tabs">
        <button onclick="window.location.href='/'" class="nav-button">Chart</button>
        <button class="nav-button active">Spread Analysis</button>
        <button onclick="window.location.href='/vwap?symbol=AAPL'" class="nav-button">VWAP Analysis</button>
        <button onclick="window.location.href='/volume?symbol=AAPL'" class="nav-button">Volume Analysis</button>
        <button onclick="window.location.href='/liquidity?symbol=AAPL'" class="nav-button">Liquidity Analysis</button>
        <button onclick="window.location.href='/flow?symbol=AAPL'" class="nav-button">Order Flow</button>
    </div>

    <div class="stats-grid" id="stats-container">
        <div class="stat-card">
            <div class="stat-value" id="squeeze-potential">Loading...</div>
            <div class="stat-label">Squeeze Potential</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="compression-ratio">Loading...</div>
            <div class="stat-label">Compression Ratio</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="spread-efficiency">Loading...</div>
            <div class="stat-label">Spread Efficiency</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="liquidity-risk">Loading...</div>
            <div class="stat-label">Liquidity Risk</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="mean-reversion">Loading...</div>
            <div class="stat-label">Mean Reversion</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="volatility-regime">Loading...</div>
            <div class="stat-label">Volatility Regime</div>
        </div>
    </div>

    <div class="chart-container" id="spread-time-chart"></div>
    <div class="chart-container" id="spread-distribution-chart"></div>

    <script>
        async function loadSpreadData() {
            try {
                console.log('üîÑ Loading spread data...');
                const response = await fetch('/api/spread?symbol={{ symbol }}');
                const data = await response.json();
                
                if (data.s !== "ok") {
                    throw new Error('No spread data available');
                }

                // Convert timestamps to dates
                const dates = data.t.map(timestamp => new Date(timestamp * 1000));
                
                // Calculate statistics
                const minSpread = Math.min(...data.min_spread);
                const maxSpread = Math.max(...data.max_spread);
                const avgSpread = (data.min_spread.reduce((a, b) => a + b, 0) + data.max_spread.reduce((a, b) => a + b, 0)) / (data.min_spread.length + data.max_spread.length);
                
                // Calculate spread volatility (standard deviation)
                const allSpreads = [...data.min_spread, ...data.max_spread];
                const mean = allSpreads.reduce((a, b) => a + b, 0) / allSpreads.length;
                const variance = allSpreads.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / allSpreads.length;
                const spreadVolatility = Math.sqrt(variance);

                // Calculate sophisticated spread microstructure metrics
                
                // Squeeze Potential - Measures compression for breakout potential
                const squeezePotential = maxSpread > 0 ? ((maxSpread - minSpread) / maxSpread * 100) : 0;
                
                // Compression Ratio - Current spread relative to range
                const currentSpread = allSpreads[allSpreads.length - 1] || avgSpread;
                const compressionRatio = maxSpread > 0 ? (currentSpread / maxSpread) : 0;
                
                // Spread Efficiency - Consistency measure (lower volatility is more efficient)
                const spreadEfficiency = avgSpread > 0 ? Math.max(0, (1 - (spreadVolatility / avgSpread)) * 100) : 0;
                
                // Liquidity Risk - Based on spread coefficient of variation
                const liquidityRisk = avgSpread > 0 ? (spreadVolatility / avgSpread * 100) : 0;
                
                // Mean Reversion Strength - How strongly current spread reverts to mean
                const meanReversion = spreadVolatility > 0 ? Math.exp(-Math.abs(currentSpread - avgSpread) / spreadVolatility) * 100 : 50;
                
                // Volatility Regime Classification
                const volRegime = liquidityRisk > 30 ? 'High Vol' : liquidityRisk > 15 ? 'Medium Vol' : 'Low Vol';
                
                // Update sophisticated statistics
                document.getElementById('squeeze-potential').textContent = `${squeezePotential.toFixed(1)}%`;
                document.getElementById('compression-ratio').textContent = compressionRatio.toFixed(3);
                document.getElementById('spread-efficiency').textContent = `${spreadEfficiency.toFixed(1)}%`;
                document.getElementById('liquidity-risk').textContent = `${liquidityRisk.toFixed(1)}%`;
                document.getElementById('mean-reversion').textContent = `${meanReversion.toFixed(1)}%`;
                document.getElementById('volatility-regime').textContent = volRegime;

                // Create time series chart
                const minSpreadTrace = {
                    x: dates,
                    y: data.min_spread,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Min Spread',
                    line: { color: '#4CAF50', width: 2 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(76, 175, 80, 0.1)'
                };

                const maxSpreadTrace = {
                    x: dates,
                    y: data.max_spread,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Max Spread',
                    line: { color: '#FF5722', width: 2 }
                };

                const avgSpreadTrace = {
                    x: dates,
                    y: data.min_spread.map((min, i) => (min + data.max_spread[i]) / 2),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Average Spread',
                    line: { color: '#2196F3', width: 2, dash: 'dash' }
                };

                const timeLayout = {
                    title: 'Bid-Ask Spread Over Time',
                    paper_bgcolor: 'white',
                    plot_bgcolor: 'white',
                    font: { color: 'black' },
                    xaxis: { 
                        title: 'Time',
                        gridcolor: '#e6e6e6'
                    },
                    yaxis: { 
                        title: 'Spread ($)',
                        gridcolor: '#e6e6e6'
                    },
                    margin: { t: 50, r: 50, b: 50, l: 50 },
                    hovermode: 'x unified'
                };

                Plotly.newPlot('spread-time-chart', [minSpreadTrace, maxSpreadTrace, avgSpreadTrace], timeLayout, {responsive: true});

                // Create distribution histogram
                const spreadDistTrace = {
                    x: allSpreads,
                    type: 'histogram',
                    name: 'Spread Distribution',
                    marker: { color: '#00d4aa', opacity: 0.7 },
                    nbinsx: 30
                };

                const distLayout = {
                    title: 'Spread Distribution',
                    paper_bgcolor: 'white',
                    plot_bgcolor: 'white',
                    font: { color: 'black' },
                    xaxis: { 
                        title: 'Spread ($)',
                        gridcolor: '#e6e6e6'
                    },
                    yaxis: { 
                        title: 'Frequency',
                        gridcolor: '#e6e6e6'
                    },
                    margin: { t: 50, r: 50, b: 50, l: 50 }
                };

                Plotly.newPlot('spread-distribution-chart', [spreadDistTrace], distLayout, {responsive: true});

                console.log('‚úÖ Spread analysis loaded successfully');
                console.log(`üìä Stats: Min=$${minSpread.toFixed(4)}, Max=$${maxSpread.toFixed(4)}, Avg=$${avgSpread.toFixed(4)}, Vol=$${spreadVolatility.toFixed(4)}`);

            } catch (error) {
                console.error('‚ùå Error loading spread data:', error);
                document.getElementById('squeeze-potential').textContent = 'Error';
                document.getElementById('compression-ratio').textContent = 'Error';
                document.getElementById('spread-efficiency').textContent = 'Error';
                document.getElementById('liquidity-risk').textContent = 'Error';
                document.getElementById('mean-reversion').textContent = 'Error';
                document.getElementById('volatility-regime').textContent = 'Error';
            }
        }

        // Load data when page loads
        window.addEventListener('DOMContentLoaded', loadSpreadData);
    </script>
</body>
</html>